<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>DiNGo — Live Multiplayer Bingo</title>

  <!-- ── PWA Meta Tags ── -->
  <meta name="theme-color" content="#00ffcc"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="DiNGo"/>
  <meta name="description" content="5-in-a-row live multiplayer bingo. Challenge friends or battle the AI bot."/>
  <!-- Manifest injected via JS below (single-file PWA) -->
  <link id="pwa-manifest" rel="manifest" href=""/>
  <!-- Apple touch icons (generated from inline SVG → data URI via JS) -->
  <link id="apple-icon" rel="apple-touch-icon" href=""/>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
  /* ═══════════════════════════════════════════════
     DiNGo — NEON ARCADE
     Direction: Fighting game character select.
     Chunky. Color-blocked. Electric. Zero blur.
     Energy from contrast, not from animation noise.
  ═══════════════════════════════════════════════ */
  :root {
    --bg:      #0d0d0f;
    --ink:     #ffffff;
    --ink2:    rgba(255,255,255,0.5);
    --ink3:    rgba(255,255,255,0.18);
    --c1:      #00ffcc;   /* electric mint  */
    --c2:      #ff2d55;   /* hot red        */
    --c3:      #ffcc00;   /* arcade yellow  */
    --c4:      #7b61ff;   /* deep violet    */
    --c5:      #00b4ff;   /* sky blue       */
    --panel:   #141416;
    --panel2:  #1c1c1f;
    --edge:    rgba(255,255,255,0.08);
    --edge2:   rgba(255,255,255,0.14);
    --r:       8px;
    --r-lg:    16px;
  }
  body.light {
    --bg:    #f5f5f0;
    --ink:   #0d0d0f;
    --ink2:  rgba(0,0,0,0.5);
    --ink3:  rgba(0,0,0,0.15);
    --panel: #ffffff;
    --panel2:#f0f0eb;
    --edge:  rgba(0,0,0,0.08);
    --edge2: rgba(0,0,0,0.14);
  }

  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body{width:100%;height:100%;overflow:hidden}
  body{
    font-family:'Space Grotesk',sans-serif;
    background:var(--bg);color:var(--ink);
    display:flex;align-items:center;justify-content:center;
  }

  /* ── Scanline texture via CSS only ── */
  body::after{
    content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
    background:repeating-linear-gradient(
      0deg,
      transparent,transparent 2px,
      rgba(0,0,0,0.04) 2px,rgba(0,0,0,0.04) 3px
    );
  }
  body.light::after{background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.015) 2px,rgba(0,0,0,0.015) 3px)}

  /* Kill all canvas/particle elements */
  #bg-canvas,.bg-grid,.particles,.home-grid-bg,.home-grid-canvas,.scanlines,#splash-canvas{display:none!important}

  /* ── UI Buttons (Home + Theme) ── */
  .ui-pill{
    position:fixed;top:12px;z-index:600;
    display:flex;align-items:center;gap:5px;
    font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:800;
    letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;
    border:none;outline:none;
    border-radius:6px;
    padding:0;overflow:hidden;
    transition:transform .12s,filter .12s;
    box-shadow:3px 3px 0 rgba(0,0,0,0.4);
  }
  .ui-pill:hover{transform:translate(-1px,-1px);filter:brightness(1.1)}
  .ui-pill:active{transform:translate(1px,1px);box-shadow:1px 1px 0 rgba(0,0,0,0.3)}
  /* Inner layout */
  .ui-pill .pill-icon{
    display:flex;align-items:center;justify-content:center;
    width:32px;height:32px;font-size:13px;
    background:rgba(0,0,0,0.25);flex-shrink:0;
  }
  .ui-pill .pill-label{
    padding:0 11px;color:inherit;white-space:nowrap;
  }
  /* Home button — electric mint */
  #global-home-btn{
    left:12px;display:none;
    background:var(--c1);color:#000;
  }
  #global-home-btn .pill-icon{background:rgba(0,0,0,0.2)}
  /* Theme button — deep violet */
  #theme-toggle{
    right:12px;
    background:var(--c4);color:#fff;
  }
  #theme-toggle .pill-icon{background:rgba(0,0,0,0.25)}
  body.light #theme-toggle{background:#222;color:#fff}

  /* ── Screen system ── */
  .screen{
    position:fixed;inset:0;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:12px;
    opacity:0;pointer-events:none;
    transform:translateY(14px);
    transition:opacity .28s ease,transform .28s ease;
    z-index:10;
  }
  .screen.active{opacity:1;pointer-events:all;transform:translateY(0)}
  .screen.exit{opacity:0;transform:translateY(-10px)}

  /* ── CARD ──
     Hard border + color accent bar on the left edge.
     Depth via nested dark panels not blur.
  ── */
  .card{
    background:var(--panel);
    border:2px solid var(--edge2);
    border-radius:var(--r-lg);
    width:100%;max-width:440px;
    position:relative;overflow:hidden;
    box-shadow:
      0 0 0 1px rgba(0,255,204,0.06),
      8px 8px 0 rgba(0,0,0,0.35);
  }
  body.light .card{box-shadow:8px 8px 0 rgba(0,0,0,0.08),0 0 0 1px rgba(0,0,0,0.06)}
  /* Color-block top bar */
  .card::before{
    content:'';position:absolute;top:0;left:0;right:0;height:3px;
    background:linear-gradient(90deg, var(--c1) 0%, var(--c2) 50%, var(--c3) 100%);
  }
  .card::after{display:none}
  .card-body{
    padding:26px 24px 22px;
    overflow-y:auto;max-height:calc(100vh - 52px);
    scrollbar-width:none;
  }
  .card-body::-webkit-scrollbar{display:none}

  /* ═══════════════════════════════════════════════
     SPLASH
  ═══════════════════════════════════════════════ */
  #splash-screen{background:transparent;padding:0}
  #splash-screen .card{
    max-width:480px;text-align:center;
    /* Big diagonal color stripe behind the logo */
    background:var(--panel);
    overflow:hidden;
  }
  #splash-screen .card-body{padding:48px 32px 52px;overflow:visible}

  /* Diagonal stripe */
  #splash-screen .card-body::before{
    content:'';position:absolute;
    top:-60px;right:-80px;
    width:260px;height:260px;
    background:var(--c1);
    opacity:0.04;
    transform:rotate(35deg);
    border-radius:var(--r);
    pointer-events:none;
  }

  .splash-top-badge{
    display:inline-flex;align-items:center;gap:7px;
    background:var(--panel2);
    border:2px solid var(--c1);
    border-radius:var(--r);padding:4px 12px;
    font-size:9px;letter-spacing:3px;text-transform:uppercase;font-weight:700;
    color:var(--c1);margin-bottom:28px;animation:fadeUp .4s .1s both;
  }
  .badge-live-dot{width:5px;height:5px;border-radius:50%;background:var(--c1);animation:blink2 1.4s infinite}
  @keyframes blink2{0%,100%{opacity:1}50%{opacity:.2}}

  .splash-ring{display:none}
  .splash-logo-wrap{display:block;margin-bottom:4px}

  /* LOGO — massive, two-tone, no gradient */
  .splash-logo{
    font-family:'Black Han Sans',sans-serif;
    font-size:clamp(88px,22vw,148px);
    color:var(--ink);
    display:block;line-height:.88;
    letter-spacing:-2px;
    animation:logoIn .6s cubic-bezier(.2,.8,.4,1.1) both;
    position:relative;
  }
  /* Drop shadow colored echo */
  .splash-logo::after{
    content:'DiNGo';
    position:absolute;left:4px;top:4px;
    color:var(--c1);
    z-index:-1;
    opacity:0.4;
  }
  @keyframes logoIn{0%{opacity:0;transform:scale(.85)}100%{opacity:1;transform:scale(1)}}

  .splash-tagline{
    font-size:11px;letter-spacing:4px;text-transform:uppercase;
    color:var(--ink2);margin-top:12px;margin-bottom:4px;
    animation:fadeUp .4s .25s both;font-weight:700;
  }
  .splash-game-sub{
    font-size:11px;letter-spacing:3px;text-transform:uppercase;
    color:var(--ink3);margin-bottom:24px;
    animation:fadeUp .4s .35s both;
  }
  .splash-desc{
    font-size:14px;color:var(--ink2);line-height:1.7;
    margin-bottom:30px;max-width:300px;margin-inline:auto;
    animation:fadeUp .4s .4s both;
  }
  .splash-desc strong{color:var(--ink);font-weight:700}

  /* Stats — color-block cells */
  .splash-stats{
    display:flex;justify-content:center;
    margin-bottom:30px;animation:fadeUp .4s .45s both;
    border:2px solid var(--edge2);border-radius:var(--r);overflow:hidden;
  }
  .splash-stat{display:flex;flex-direction:column;align-items:center;gap:2px;padding:12px 22px;flex:1;border-right:2px solid var(--edge2)}
  .splash-stat:last-child{border-right:none}
  .splash-stat-num{font-family:'Black Han Sans',sans-serif;font-size:26px;color:var(--ink);line-height:1}
  .splash-stat-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);font-weight:700}
  .splash-stat-divider{display:none}

  .btn-splash-enter{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    padding:16px 44px;font-size:14px;letter-spacing:2px;text-transform:uppercase;
    font-family:'Space Grotesk',sans-serif;font-weight:800;
    border:2px solid var(--c1);border-radius:var(--r);cursor:pointer;
    background:var(--c1);color:#000;
    box-shadow:4px 4px 0 rgba(0,255,204,0.3);
    animation:fadeUp .4s .55s both;
    transition:transform .12s,box-shadow .12s;
  }
  .btn-splash-enter:hover{transform:translate(-2px,-2px);box-shadow:6px 6px 0 rgba(0,255,204,0.4)}
  .btn-splash-enter:active{transform:translate(2px,2px);box-shadow:2px 2px 0 rgba(0,255,204,0.2)}
  .btn-enter-icon{font-size:16px}
  @keyframes splashShimmer{}@keyframes splashBtnPulse{}@keyframes enterIconSpin{}
  .splash-micro{margin-top:14px;font-size:10px;color:var(--ink3);letter-spacing:1.5px;text-transform:uppercase;animation:fadeUp .3s .7s both}
  @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

  /* ═══════════════════════════════════════════════
     BUTTONS
  ═══════════════════════════════════════════════ */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:7px;
    border:2px solid transparent;outline:none;cursor:pointer;
    font-family:'Space Grotesk',sans-serif;font-weight:700;
    font-size:12px;letter-spacing:1.5px;text-transform:uppercase;
    border-radius:var(--r);padding:11px 18px;
    transition:transform .1s,box-shadow .1s,background .1s;
    position:relative;overflow:hidden;
  }
  .btn::before{display:none}
  .btn:active{transform:translate(2px,2px)!important;box-shadow:none!important}
  .btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important}
  .btn-full{width:100%}

  .btn-primary{
    background:var(--c1);color:#000;border-color:var(--c1);
    box-shadow:3px 3px 0 rgba(0,255,204,0.25);
  }
  .btn-primary:hover{transform:translate(-1px,-1px);box-shadow:4px 4px 0 rgba(0,255,204,0.3)}

  .btn-pink{
    background:var(--c2);color:#fff;border-color:var(--c2);
    box-shadow:3px 3px 0 rgba(255,45,85,0.25);
  }
  .btn-pink:hover{transform:translate(-1px,-1px);box-shadow:4px 4px 0 rgba(255,45,85,0.3)}

  .btn-gold{
    background:var(--c3);color:#000;border-color:var(--c3);
    box-shadow:3px 3px 0 rgba(255,204,0,0.25);
  }
  .btn-gold:hover{transform:translate(-1px,-1px);box-shadow:4px 4px 0 rgba(255,204,0,0.3)}

  .btn-ghost{
    background:transparent;color:var(--ink2);border-color:var(--edge2);
  }
  .btn-ghost:hover{color:var(--ink);border-color:var(--ink2)}
  body.light .btn-ghost{color:var(--ink2);border-color:var(--edge2)}

  /* ═══════════════════════════════════════════════
     NAME SCREEN
  ═══════════════════════════════════════════════ */
  .screen-logo{
    font-family:'Black Han Sans',sans-serif;
    font-size:40px;letter-spacing:2px;color:var(--ink);margin-bottom:4px;
  }
  .screen-sub{font-size:13px;color:var(--ink2);margin-bottom:22px;letter-spacing:.2px}
  .field-label{
    font-size:10px;font-weight:700;color:var(--ink2);
    margin-bottom:8px;letter-spacing:2.5px;text-transform:uppercase;
  }
  input[type="text"]{
    width:100%;background:var(--panel2);
    border:2px solid var(--edge2);border-radius:var(--r);
    padding:11px 13px;font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:500;
    color:var(--ink);outline:none;
    transition:border-color .12s;
  }
  input[type="text"]:focus{border-color:var(--c1)}
  input[type="text"]::placeholder{color:var(--ink3)}

  .avatar-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:18px}
  .avatar-opt{
    aspect-ratio:1;border-radius:var(--r);border:2px solid var(--edge);
    background:var(--panel2);display:flex;align-items:center;justify-content:center;
    font-size:20px;cursor:pointer;transition:border-color .12s,transform .12s;
  }
  .avatar-opt:hover{border-color:var(--edge2);transform:scale(1.08)}
  .avatar-opt.selected{border-color:var(--c1);background:rgba(0,255,204,.08);transform:scale(1.1)}

  .color-strip{display:flex;gap:7px;margin-bottom:18px;flex-wrap:wrap}
  .color-swatch{
    width:30px;height:30px;border-radius:50%;cursor:pointer;
    border:3px solid transparent;transition:transform .12s;
  }
  .color-swatch:hover{transform:scale(1.15)}
  .color-swatch.selected{border-color:var(--ink);transform:scale(1.2)}

  /* ═══════════════════════════════════════════════
     HOME SCREEN
  ═══════════════════════════════════════════════ */
  #home-screen .card{max-width:460px}

  /* Profile strip — dark band with accent */
  .home-profile-strip{
    display:flex;align-items:center;gap:11px;
    background:var(--panel2);border:2px solid var(--edge);
    border-radius:var(--r);padding:10px 12px;
    margin-bottom:14px;
    position:relative;overflow:hidden;
  }
  /* Accent left stripe */
  .home-profile-strip::before{
    content:'';position:absolute;left:0;top:0;bottom:0;width:3px;
    background:var(--c1);
  }
  .home-avatar-wrap{position:relative;flex-shrink:0;margin-left:6px}
  .home-avatar{
    width:42px;height:42px;border-radius:var(--r);
    background:var(--panel);border:2px solid var(--edge2);
    display:flex;align-items:center;justify-content:center;font-size:21px;
  }
  .home-rank-badge{
    position:absolute;bottom:-6px;right:-6px;
    font-size:7px;font-weight:800;letter-spacing:1px;text-transform:uppercase;
    background:var(--c3);color:#000;border-radius:3px;padding:2px 5px;
  }
  .home-profile-info{flex:1;min-width:0}
  .home-username{font-size:15px;font-weight:700;margin-bottom:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .home-rank-label{font-size:10px;color:var(--ink2);letter-spacing:1px}
  .home-profile-nodes{display:flex;gap:4px;margin-left:auto;flex-shrink:0;align-items:center}
  .node-dot{width:6px;height:6px;border-radius:2px}
  .node-dot:nth-child(1){background:var(--c1);opacity:.7}
  .node-dot:nth-child(2){background:var(--c3);opacity:.5}
  .node-dot:nth-child(3){background:var(--c2);opacity:.35}
  @keyframes nodePulse{}

  /* Banners */
  .home-banners{
    margin-bottom:12px;overflow:hidden;border-radius:var(--r);
    border:2px solid var(--edge);height:48px;background:var(--panel2);position:relative;
  }
  .banner-slide{position:absolute;inset:0;display:flex;align-items:center;gap:9px;padding:0 12px;opacity:0;transition:opacity .4s ease;pointer-events:none}
  .banner-slide.active{opacity:1;pointer-events:all}
  .banner-slide.banner-rush,.banner-slide.banner-event,.banner-slide.banner-skin{background:none}
  .banner-icon{font-size:18px;flex-shrink:0}
  .banner-title{font-size:12px;font-weight:700;letter-spacing:.1px;line-height:1.3}
  .banner-sub{font-size:10px;color:var(--ink2);margin-top:1px}
  .banner-dots{display:flex;gap:4px;position:absolute;bottom:4px;right:9px}
  .banner-dot{width:4px;height:4px;border-radius:2px;background:var(--edge2);transition:background .2s}
  .banner-dot.active{background:var(--c1)}

  /* Puzzle section */
  .home-puzzle-section{
    background:var(--panel2);border:2px solid var(--edge);
    border-radius:var(--r);padding:11px 12px;margin-bottom:12px;cursor:pointer;
    transition:border-color .12s;position:relative;overflow:hidden;
  }
  .home-puzzle-section:hover{border-color:var(--c3)}
  .home-puzzle-section::before{
    content:'';position:absolute;right:-20px;top:-20px;
    width:80px;height:80px;border-radius:50%;
    background:var(--c3);opacity:.04;pointer-events:none;
  }
  .puzzle-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .puzzle-label{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--c3);font-weight:700}
  .puzzle-timer{font-size:10px;color:var(--ink2)}
  .puzzle-mini-board{display:grid;grid-template-columns:repeat(5,1fr);gap:2px}
  .puzzle-cell{aspect-ratio:1;border-radius:3px;background:var(--panel);border:2px solid var(--edge);display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:var(--ink3)}
  .puzzle-cell.filled{background:rgba(0,255,204,.08);border-color:rgba(0,255,204,.3);color:var(--c1)}
  .puzzle-cell.clickable{cursor:pointer;border-color:rgba(255,204,0,.3);color:var(--ink2);transition:border-color .12s,background .12s,transform .1s}
  .puzzle-cell.clickable:hover{background:rgba(255,204,0,.1);border-color:var(--c3);color:var(--c3);transform:scale(1.1)}
  .puzzle-cell.correct{background:rgba(0,255,204,.2)!important;border-color:var(--c1)!important;color:var(--c1)!important;animation:correctPop .3s cubic-bezier(.2,.8,.4,1.2)}
  .puzzle-cell.wrong{animation:wrongShake .35s ease}
  .puzzle-cell.revealed-win{background:rgba(255,204,0,.15)!important;border-color:var(--c3)!important;color:var(--c3)!important;animation:hintGlow 1.4s infinite}
  .puzzle-cell.done-filled{background:rgba(0,255,204,.08);border-color:rgba(0,255,204,.3);color:var(--c1)}
  .puzzle-cell.done-answer{background:rgba(255,204,0,.15);border-color:var(--c3);color:var(--c3)}
  @keyframes correctPop{0%{transform:scale(.7);opacity:.4}100%{transform:scale(1);opacity:1}}
  @keyframes wrongShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
  @keyframes hintGlow{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(255,204,0,.4)}}
  .puzzle-cta{font-size:10px;color:var(--ink2);margin-top:6px;text-align:center}
  .puzzle-result{margin-top:7px;text-align:center;font-size:11px;font-weight:700;letter-spacing:.5px;padding:5px 10px;border-radius:5px}
  .puzzle-result.win{color:var(--c1);background:rgba(0,255,204,.08);border:1px solid rgba(0,255,204,.2)}
  .puzzle-result.lose{color:var(--c2);background:rgba(255,45,85,.08);border:1px solid rgba(255,45,85,.2)}
  .puzzle-result.done{color:var(--c3);background:rgba(255,204,0,.08);border:1px solid rgba(255,204,0,.2)}

  /* Lobby chat */
  .home-lobby-chat{background:var(--panel2);border:2px solid var(--edge);border-radius:var(--r);padding:10px 12px;margin-bottom:12px}
  .lobby-chat-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .lobby-chat-label{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--c5);font-weight:700;display:flex;align-items:center;gap:5px}
  .lobby-live-dot{width:5px;height:5px;border-radius:50%;background:var(--c1);animation:blink2 1.4s infinite}
  .lobby-chat-count{font-size:10px;color:var(--ink2)}
  .lobby-messages{display:flex;flex-direction:column;gap:3px}
  .lobby-msg{display:flex;align-items:center;gap:6px;font-size:12px}
  .lobby-msg-avatar{font-size:12px;flex-shrink:0}
  .lobby-msg-name{font-weight:700;color:var(--ink2);font-size:10px;white-space:nowrap}
  .lobby-msg-text{color:var(--ink);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}

  .home-action-zone{position:relative}

  /* PLAY NOW — biggest energy button on screen */
  .btn-play-now{
    width:100%;padding:18px 24px;font-size:16px;letter-spacing:2.5px;text-transform:uppercase;
    font-family:'Black Han Sans',sans-serif;
    background:var(--c1);color:#000;
    border:2px solid var(--c1);border-radius:var(--r);cursor:pointer;
    display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px;
    box-shadow:4px 4px 0 rgba(0,255,204,0.3);
    transition:transform .1s,box-shadow .1s;
    position:relative;overflow:hidden;
  }
  /* Color band behind text */
  .btn-play-now::after{
    content:'';position:absolute;inset:0;
    background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.12) 50%,transparent 100%);
    transform:skewX(-20deg);
  }
  .btn-play-now::before{display:none}
  .btn-play-now:hover{transform:translate(-2px,-2px);box-shadow:6px 6px 0 rgba(0,255,204,0.35)}
  .btn-play-now:active{transform:translate(2px,2px);box-shadow:2px 2px 0 rgba(0,255,204,0.15)}
  .play-now-icon{font-size:18px;position:relative;z-index:1}
  .btn-play-now span:last-child{position:relative;z-index:1}
  @keyframes playIconBounce{}@keyframes playNowShimmer{}@keyframes playNowPulse{}

  /* VS Bot */
  .btn-vs-bot{
    width:100%;padding:12px 18px;font-size:11px;letter-spacing:2px;text-transform:uppercase;
    font-family:'Space Grotesk',sans-serif;font-weight:700;
    background:transparent;color:var(--c4);
    border:2px solid var(--c4);border-radius:var(--r);cursor:pointer;
    display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px;
    box-shadow:3px 3px 0 rgba(123,97,255,0.2);
    transition:transform .1s,box-shadow .1s,background .1s;
  }
  .btn-vs-bot::before{display:none}
  .btn-vs-bot:hover{background:rgba(123,97,255,.1);transform:translate(-1px,-1px);box-shadow:4px 4px 0 rgba(123,97,255,0.3)}
  .bot-icon{font-size:14px}

  .home-private-row{display:flex;gap:7px;margin-bottom:4px}
  .home-private-row button{flex:1;font-size:10px}
  .join-row input{flex:1;letter-spacing:4px;text-transform:uppercase}
  #home-msg{min-height:16px;font-size:12px;font-weight:700;text-align:center;margin-top:10px;color:var(--c2);letter-spacing:.5px}

  /* AI Modal */
  #ai-difficulty-modal{
    position:fixed;inset:0;z-index:700;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.8);
    opacity:0;pointer-events:none;transition:opacity .2s;padding:20px;
  }
  #ai-difficulty-modal.show{opacity:1;pointer-events:all}
  .diff-card{
    background:var(--panel);border:2px solid var(--edge2);
    border-radius:var(--r-lg);padding:24px 20px;width:100%;max-width:320px;
    box-shadow:6px 6px 0 rgba(0,0,0,.5);
    animation:diffCardIn .2s ease both;position:relative;overflow:hidden;
  }
  .diff-card::before{
    content:'';position:absolute;top:0;left:0;right:0;height:3px;
    background:linear-gradient(90deg,var(--c4),var(--c2));
  }
  @keyframes diffCardIn{0%{transform:translateY(14px);opacity:0}100%{transform:translateY(0);opacity:1}}
  .diff-title{font-family:'Black Han Sans',sans-serif;font-size:28px;letter-spacing:3px;color:var(--ink);text-align:center;margin-bottom:4px}
  .diff-sub{font-size:9px;text-align:center;color:var(--ink2);letter-spacing:3px;text-transform:uppercase;margin-bottom:18px;font-weight:700}
  .diff-option{
    display:flex;align-items:center;gap:12px;
    background:var(--panel2);border:2px solid var(--edge);
    border-radius:var(--r);padding:11px 13px;margin-bottom:7px;
    cursor:pointer;transition:border-color .12s,transform .1s;
  }
  .diff-option:last-of-type{margin-bottom:0}
  .diff-option:hover{border-color:var(--edge2);transform:translate(-1px,-1px)}
  .diff-option:active{transform:translate(1px,1px)}
  .diff-emoji{font-size:22px;flex-shrink:0}
  .diff-info{flex:1}
  .diff-name{font-size:14px;font-weight:700;margin-bottom:1px}
  .diff-desc{font-size:11px;color:var(--ink2);line-height:1.4}
  .diff-badge{font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;border-radius:3px;padding:3px 7px;flex-shrink:0}
  .badge-easy{background:rgba(0,255,204,.1);color:var(--c1);border:2px solid rgba(0,255,204,.25)}
  .badge-medium{background:rgba(255,204,0,.1);color:var(--c3);border:2px solid rgba(255,204,0,.25)}
  .badge-hard{background:rgba(255,45,85,.1);color:var(--c2);border:2px solid rgba(255,45,85,.25)}
  .diff-cancel{display:block;width:100%;margin-top:10px;background:none;border:none;color:var(--ink2);font-family:'Space Grotesk',sans-serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;font-weight:700;padding:8px;transition:color .12s}
  .diff-cancel:hover{color:var(--ink)}

  /* ── How to Play Modal ── */
  #htp-modal{
    position:fixed;inset:0;z-index:800;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.82);backdrop-filter:blur(4px);
    opacity:0;pointer-events:none;transition:opacity .22s;padding:16px;
  }
  #htp-modal.show{opacity:1;pointer-events:all}
  .htp-card{
    background:var(--panel);border:2px solid var(--edge2);
    border-radius:var(--r-lg);padding:0;width:100%;max-width:360px;
    box-shadow:8px 8px 0 rgba(0,0,0,.5);
    animation:diffCardIn .22s ease both;
    position:relative;overflow:hidden;max-height:90vh;overflow-y:auto;
    scrollbar-width:none;
  }
  .htp-card::-webkit-scrollbar{display:none}
  .htp-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;
    background:linear-gradient(90deg,var(--c1),var(--c4),var(--c2));z-index:1}
  .htp-header{
    display:flex;align-items:center;justify-content:space-between;
    padding:18px 18px 0;
  }
  .htp-title{font-family:'Black Han Sans',sans-serif;font-size:26px;letter-spacing:3px;color:var(--ink)}
  .htp-close{background:none;border:2px solid var(--edge2);color:var(--ink2);
    width:30px;height:30px;border-radius:6px;cursor:pointer;font-size:14px;
    display:flex;align-items:center;justify-content:center;
    transition:border-color .12s,color .12s}
  .htp-close:hover{border-color:var(--c2);color:var(--c2)}
  .htp-body{padding:12px 18px 22px}
  .htp-step{
    display:flex;align-items:flex-start;gap:12px;
    padding:10px 0;border-bottom:1px solid var(--edge);
  }
  .htp-step:last-child{border-bottom:none}
  .htp-step-num{
    width:26px;height:26px;border-radius:6px;flex-shrink:0;
    display:flex;align-items:center;justify-content:center;
    font-family:'Black Han Sans',sans-serif;font-size:13px;
    background:var(--panel2);border:2px solid var(--edge2);color:var(--c1);
  }
  .htp-step-text{flex:1;font-size:12px;color:var(--ink2);line-height:1.6}
  .htp-step-text strong{color:var(--ink);font-weight:700}
  .htp-win-demo{
    margin:12px 0;display:grid;grid-template-columns:repeat(5,1fr);gap:3px;
  }
  .htp-cell{
    aspect-ratio:1;border-radius:4px;border:2px solid var(--edge);
    background:var(--panel2);display:flex;align-items:center;justify-content:center;
    font-size:9px;font-weight:700;color:var(--ink3);font-family:'Black Han Sans',sans-serif;
  }
  .htp-cell.cx{background:rgba(0,255,204,.1);border-color:rgba(0,255,204,.4);color:var(--c1)}
  .htp-cell.win{background:rgba(255,204,0,.18);border-color:var(--c3);color:var(--c3);
    animation:winLinePulse 1.6s ease-in-out infinite}
  .htp-tag{display:inline-block;font-size:8px;font-weight:700;letter-spacing:1.5px;
    text-transform:uppercase;border-radius:3px;padding:2px 7px;margin-top:4px}
  .htp-tag.green{background:rgba(0,255,204,.1);color:var(--c1);border:1px solid rgba(0,255,204,.25)}
  .htp-tag.gold{background:rgba(255,204,0,.1);color:var(--c3);border:1px solid rgba(255,204,0,.25)}
  .htp-tag.red{background:rgba(255,45,85,.1);color:var(--c2);border:1px solid rgba(255,45,85,.25)}

  /* ── Abandon countdown banner ── */
  #abandon-banner{
    position:fixed;top:56px;left:50%;transform:translateX(-50%) translateY(-20px);
    z-index:900;opacity:0;pointer-events:none;
    transition:opacity .3s,transform .3s;
    background:var(--panel);border:2px solid var(--c2);border-radius:var(--r);
    padding:9px 16px;display:flex;align-items:center;gap:10px;
    box-shadow:4px 4px 0 rgba(255,45,85,.25);
    white-space:nowrap;
  }
  #abandon-banner.show{opacity:1;pointer-events:all;transform:translateX(-50%) translateY(0)}
  .abandon-icon{font-size:18px}
  .abandon-text{font-size:11px;color:var(--ink2);font-weight:600}
  .abandon-text strong{color:var(--c2)}
  #abandon-timer{
    font-family:'Black Han Sans',sans-serif;font-size:22px;color:var(--c2);
    min-width:28px;text-align:center;line-height:1;
  }

  /* AI thinking */
  #ai-thinking-bar{display:none;align-items:center;gap:6px;justify-content:center;font-size:10px;color:var(--c4);letter-spacing:2.5px;text-transform:uppercase;font-weight:700;margin-bottom:6px}
  #ai-thinking-bar.show{display:flex}
  .think-dot{width:4px;height:4px;border-radius:1px;background:var(--c4);animation:thinkBounce .9s ease-in-out infinite}
  .think-dot:nth-child(2){animation-delay:.18s}.think-dot:nth-child(3){animation-delay:.36s}
  @keyframes thinkBounce{0%,100%{transform:translateY(0);opacity:.3}50%{transform:translateY(-5px);opacity:1}}
  .ai-mode-pill{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;font-weight:700;background:rgba(123,97,255,.1);color:var(--c4);border:2px solid rgba(123,97,255,.2);border-radius:3px;padding:2px 7px;display:none}
  .ai-mode-pill.show{display:inline-block}
  .player-box.is-bot{border-color:rgba(123,97,255,.2)}
  .player-box.is-bot.active-turn{border-color:var(--c4)!important;box-shadow:4px 4px 0 rgba(123,97,255,.15)!important}
  .player-box.is-bot::after{background:linear-gradient(180deg,var(--c4),var(--c2))!important}

  /* ═══════════════════════════════════════════════
     ROOM BADGE
  ═══════════════════════════════════════════════ */
  .room-badge{
    background:var(--panel2);border:2px solid var(--edge);
    border-radius:var(--r);padding:12px 14px;margin-bottom:16px;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    position:relative;overflow:hidden;
  }
  .room-badge::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--c1)}
  .room-badge-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--ink2);margin-bottom:4px;font-weight:700}
  .room-badge-code{font-family:'Black Han Sans',sans-serif;font-size:30px;letter-spacing:6px;color:var(--c1)}
  .waiting-dots{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--ink2)}
  .dot{width:4px;height:4px;border-radius:1px;background:var(--c1);animation:blink 1.2s ease-in-out infinite}
  .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,100%{opacity:.2}50%{opacity:1}}

  /* ═══════════════════════════════════════════════
     SETUP BOARD
  ═══════════════════════════════════════════════ */
  .section-title{font-family:'Black Han Sans',sans-serif;font-size:24px;letter-spacing:3px;margin-bottom:4px}
  .section-sub{font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.5}
  .progress-bar{height:3px;background:var(--edge);border-radius:999px;overflow:hidden;margin-bottom:12px}
  .progress-fill{height:100%;background:var(--c1);width:0%;transition:width .3s ease;border-radius:999px}
  .setup-actions{display:flex;gap:6px;margin-bottom:10px}
  .setup-actions .btn{flex:1;font-size:10px;padding:8px 4px}

  /* ═══════════════════════════════════════════════
     BINGO CELLS
  ═══════════════════════════════════════════════ */
  .board-wrap{display:flex;justify-content:center;margin-bottom:10px}
  .board{
    display:grid;grid-template-columns:repeat(5,1fr);gap:4px;
    width:min(100%,min(calc(100vw - 52px),calc(100vh - 330px)));
  }
  .cell{
    border-radius:var(--r);border:2px solid var(--edge);
    background:var(--panel2);
    display:flex;align-items:center;justify-content:center;
    font-family:'Black Han Sans',sans-serif;
    font-size:clamp(13px,3.8vw,22px);
    color:var(--ink2);cursor:pointer;
    transition:background .12s,border-color .12s,color .12s,transform .1s;
    user-select:none;position:relative;overflow:hidden;aspect-ratio:1;
  }
  .cell::before{display:none}
  #setup-board .cell:not([data-filled]):hover{
    background:rgba(0,255,204,.07);border-color:rgba(0,255,204,.4);
    color:var(--ink);transform:scale(1.07)
  }
  #setup-board .cell[data-filled]{
    background:rgba(0,255,204,.1);border-color:var(--c1);
    color:var(--c1);animation:cellPop .18s cubic-bezier(.2,.8,.4,1.2);
  }
  @keyframes cellPop{0%{transform:scale(.5);opacity:0}100%{transform:scale(1);opacity:1}}
  #game-board .cell:not(.crossed):hover{
    background:rgba(255,204,0,.07);border-color:rgba(255,204,0,.4);
    color:var(--ink);transform:scale(1.06)
  }
  .cell.crossed{
    background:rgba(0,255,204,.08);border-color:rgba(0,255,204,.3);
    color:rgba(0,255,204,.3);cursor:default;
    animation:crossPop .18s ease;
  }
  .cell.crossed::after{
    content:'✕';position:absolute;inset:0;
    display:flex;align-items:center;justify-content:center;
    color:var(--c1);font-size:1.2em;opacity:.5;font-family:'Space Grotesk',sans-serif;
  }
  @keyframes crossPop{0%{transform:scale(1.3)}100%{transform:scale(1)}}
  .cell.win-line{
    background:rgba(255,204,0,.18)!important;border-color:var(--c3)!important;
    color:var(--c3)!important;z-index:2;
    animation:winLinePulse 1.4s ease-in-out infinite!important;
  }
  .cell.win-line::after{color:var(--c3)!important}
  @keyframes winLinePulse{
    0%,100%{box-shadow:0 0 6px rgba(255,204,0,.4),inset 0 0 8px rgba(255,204,0,.08)}
    50%{box-shadow:0 0 22px rgba(255,204,0,.85),0 0 44px rgba(255,204,0,.35),4px 4px 0 rgba(255,204,0,.25),inset 0 0 14px rgba(255,204,0,.15)}
  }
  /* Flash overlay that fires once when a new line is found */
  @keyframes lineBurst{
    0%{opacity:1;transform:scale(1.18)}
    100%{opacity:0;transform:scale(1)}
  }
  .cell.line-burst{
    animation:lineBurst .35s ease-out forwards, winLinePulse 1.4s ease-in-out infinite .35s!important;
    background:rgba(255,204,0,.35)!important;border-color:#ffe066!important;
    box-shadow:0 0 30px rgba(255,204,0,1),0 0 60px rgba(255,204,0,.5)!important;
  }
  /* Full-screen flash when a line is completed */
  #line-flash{
    position:fixed;inset:0;z-index:9000;
    background:rgba(255,204,0,.12);
    pointer-events:none;opacity:0;
    animation:none;
  }
  #line-flash.flash{animation:flashFade .45s ease-out forwards}
  @keyframes flashFade{0%{opacity:1}100%{opacity:0}}

  /* ═══════════════════════════════════════════════
     GAME SCREEN
  ═══════════════════════════════════════════════ */
  #game-screen .card{max-width:500px}
  #game-screen .card-body{padding:12px 12px 10px}

  .score-bar{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px}
  .score-chip{
    display:flex;flex-direction:column;align-items:center;
    background:var(--panel2);border:2px solid var(--edge);
    border-radius:var(--r);padding:5px 14px;min-width:52px;
  }
  .score-num{font-family:'Black Han Sans',sans-serif;font-size:30px;letter-spacing:2px;line-height:1}
  .score-num.c1{color:var(--c1)}.score-num.c2{color:var(--c2)}
  .score-lbl{font-size:8px;color:var(--ink2);letter-spacing:2px;text-transform:uppercase;margin-top:2px;font-weight:700}
  .vs-dot{font-size:12px;color:var(--ink3);letter-spacing:1px;font-weight:700}

  .players-row{display:flex;justify-content:space-between;align-items:stretch;gap:6px;margin-bottom:7px}
  .player-box{
    display:flex;align-items:center;gap:7px;
    background:var(--panel2);border:2px solid var(--edge);
    border-radius:var(--r);padding:7px 9px;flex:1;min-width:0;
    transition:border-color .18s;position:relative;overflow:hidden;
  }
  .player-box.p2{flex-direction:row-reverse;text-align:right}
  .player-box.active-turn{
    border-color:var(--c3)!important;
    box-shadow:4px 4px 0 rgba(255,204,0,.15);
  }
  .player-box::after{content:'';position:absolute;top:0;bottom:0;width:3px;background:var(--c1);opacity:0;transition:opacity .2s}
  .player-box.p1::after{left:0}.player-box.p2::after{right:0;background:var(--c2)}
  .player-box.active-turn::after{opacity:1}
  .player-avatar{font-size:17px;flex-shrink:0}
  .player-info{flex:1;min-width:0}
  .player-label{font-size:8px;color:var(--ink2);letter-spacing:1.5px;text-transform:uppercase;font-weight:700}
  .player-name{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:1px}
  .player-status{font-size:10px;color:var(--ink2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;font-style:italic;opacity:0;transition:opacity .3s;height:13px;line-height:13px}
  .player-status.visible{opacity:1}
  .vs-badge{font-size:11px;color:var(--ink3);flex-shrink:0;font-weight:700;letter-spacing:1px}

  #turn-indicator{
    font-family:'Black Han Sans',sans-serif;
    font-size:clamp(13px,3.5vw,18px);letter-spacing:2px;text-transform:uppercase;
    text-align:center;margin-bottom:7px;min-height:22px;transition:color .2s;
  }
  .action-row{display:flex;gap:6px;margin-top:8px}
  .action-row .btn{flex:1;font-size:10px;padding:9px 4px}

  /* ═══════════════════════════════════════════════
     NUMBER ANNOUNCEMENT
  ═══════════════════════════════════════════════ */
  #number-announce{display:flex!important;position:fixed;inset:0;z-index:150;align-items:center;justify-content:center;pointer-events:none}
  .announce-bubble{
    background:var(--panel);
    border:3px solid var(--c3);
    border-radius:var(--r-lg);padding:20px 44px;text-align:center;
    box-shadow:6px 6px 0 rgba(255,204,0,.25),0 24px 60px rgba(0,0,0,.7);
    transform:scale(0) translateY(12px);opacity:0;transition:none;
  }
  .announce-bubble.pop{animation:annPop .38s cubic-bezier(.2,.8,.4,1.3) forwards}
  .announce-bubble.fade-out{animation:annFade .22s ease forwards}
  @keyframes annPop{0%{transform:scale(.2) translateY(20px);opacity:0}60%{transform:scale(1.06) translateY(-3px);opacity:1}100%{transform:scale(1) translateY(0);opacity:1}}
  @keyframes annFade{0%{transform:scale(1);opacity:1}100%{transform:scale(.7) translateY(-12px);opacity:0}}
  .announce-who{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--c3);margin-bottom:4px;font-weight:700}
  .announce-num{font-family:'Black Han Sans',sans-serif;font-size:clamp(64px,16vw,100px);letter-spacing:4px;line-height:1;color:var(--ink)}
  .announce-sub{font-size:11px;color:var(--ink2);letter-spacing:1.5px;margin-top:4px;text-transform:uppercase}

  /* ═══════════════════════════════════════════════
     WIN OVERLAY
  ═══════════════════════════════════════════════ */
  #win-overlay{
    position:fixed;inset:0;z-index:200;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:rgba(0,0,0,.88);
    opacity:0;pointer-events:none;transition:opacity .3s;padding:24px;
  }
  #win-overlay.show{opacity:1;pointer-events:all}
  .win-title{
    font-family:'Black Han Sans',sans-serif;
    font-size:clamp(72px,20vw,120px);letter-spacing:6px;line-height:1;
    color:var(--c3);
    text-shadow:6px 6px 0 rgba(255,204,0,.2);
    animation:winBounce .7s cubic-bezier(.2,.8,.4,1.3) both;text-align:center;
  }
  @keyframes winBounce{0%{transform:scale(0.3) rotate(-4deg);opacity:0}65%{transform:scale(1.08) rotate(1deg)}80%{transform:scale(.97)}100%{transform:scale(1) rotate(0);opacity:1}}
  .win-subtitle{font-size:14px;color:var(--ink2);margin-top:8px;margin-bottom:28px;letter-spacing:1.5px;text-align:center;animation:fadeUp .4s .3s both;text-transform:uppercase;font-weight:700}
  .win-buttons{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;animation:fadeUp .4s .45s both}
  .rematch-countdown{font-size:12px;color:var(--ink2);letter-spacing:1px;margin-top:14px;text-align:center;animation:fadeUp .4s .6s both;text-transform:uppercase;font-weight:600}
  .rematch-countdown strong{color:var(--c3);font-size:16px}
  .countdown-cancel{background:none;border:none;cursor:pointer;color:var(--ink3);font-size:10px;letter-spacing:2px;text-transform:uppercase;text-decoration:underline;font-family:'Space Grotesk',sans-serif;margin-top:6px;padding:2px 6px;transition:color .12s}
  .countdown-cancel:hover{color:var(--ink)}
  #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:199}

  /* ═══════════════════════════════════════════════
     CHAT FAB + PANEL
  ═══════════════════════════════════════════════ */
  .chat-fab{
    position:fixed;bottom:22px;right:22px;
    width:50px;height:50px;border-radius:50%;
    background:var(--c1);border:2px solid var(--c1);
    cursor:pointer;display:flex;align-items:center;justify-content:center;
    font-size:20px;z-index:100;
    box-shadow:4px 4px 0 rgba(0,255,204,.25);
    transition:transform .1s,box-shadow .1s;
    color:#000;
  }
  .chat-fab:hover{transform:translate(-2px,-2px);box-shadow:6px 6px 0 rgba(0,255,204,.3)}
  .chat-fab:active{transform:translate(2px,2px);box-shadow:2px 2px 0 rgba(0,255,204,.15)}
  .chat-badge{position:absolute;top:-3px;right:-3px;width:14px;height:14px;border-radius:50%;background:var(--c2);border:2px solid var(--bg);display:none}
  .chat-badge.show{display:block}

  .chat-panel{
    position:fixed;bottom:82px;right:20px;width:285px;
    background:var(--panel);border:2px solid var(--edge2);
    border-radius:var(--r-lg);
    box-shadow:6px 6px 0 rgba(0,0,0,.4);
    z-index:99;display:flex;flex-direction:column;overflow:hidden;
    transform:scale(.88) translateY(14px);transform-origin:bottom right;
    opacity:0;pointer-events:none;
    transition:transform .22s ease,opacity .22s ease;
    position:fixed;
  }
  .chat-panel.open{transform:scale(1) translateY(0);opacity:1;pointer-events:all}
  .chat-panel::before{
    content:'';position:absolute;top:0;left:0;right:0;height:3px;
    background:linear-gradient(90deg,var(--c1),var(--c2));
  }
  .chat-header{padding:14px 14px 9px;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--ink2);border-bottom:2px solid var(--edge);font-weight:700}
  .chat-messages{flex:1;overflow-y:auto;padding:9px 11px;display:flex;flex-direction:column;gap:6px;max-height:185px;scrollbar-width:thin;scrollbar-color:var(--edge) transparent}
  .chat-msg{display:flex;flex-direction:column;gap:2px}
  .chat-msg.mine{align-items:flex-end}
  .chat-bubble{
    display:inline-block;padding:6px 11px;border-radius:var(--r);
    font-size:13px;max-width:200px;word-break:break-word;line-height:1.5;
    background:var(--panel2);border:2px solid var(--edge);
    animation:bubblePop .16s ease;
  }
  .chat-bubble.emoji-only{font-size:24px;padding:7px 10px;animation:emojiBubblePop .28s cubic-bezier(.2,.8,.4,1.4)}
  @keyframes emojiBubblePop{0%{transform:scale(.2) rotate(-8deg);opacity:0}65%{transform:scale(1.1) rotate(2deg)}100%{transform:scale(1) rotate(0);opacity:1}}
  .chat-msg.mine .chat-bubble{background:rgba(0,255,204,.08);border-color:rgba(0,255,204,.25)}
  .chat-sender{font-size:9px;color:var(--ink3);letter-spacing:.3px;font-weight:700}
  @keyframes bubblePop{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
  .chat-emojis{display:flex;flex-wrap:wrap;gap:4px;padding:8px 10px;border-top:2px solid var(--edge)}
  .emoji-btn{
    font-size:17px;width:35px;height:35px;border-radius:var(--r);
    background:var(--panel2);border:2px solid var(--edge);
    cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:transform .1s,border-color .1s;
  }
  .emoji-btn::before{display:none}
  .emoji-btn:hover{transform:scale(1.2) translateY(-2px);border-color:var(--c1)}
  .emoji-btn:active{transform:scale(1.05)}
  @keyframes emojiFloat{}
  .chat-input-row{display:flex;gap:5px;padding:7px 10px;border-top:2px solid var(--edge)}
  .chat-text-input{flex:1;background:var(--panel2);border:2px solid var(--edge);border-radius:var(--r);padding:7px 10px;color:var(--ink);font-family:'Space Grotesk',sans-serif;font-size:13px;outline:none;transition:border-color .12s}
  .chat-text-input:focus{border-color:var(--c1)}
  .chat-text-input::placeholder{color:var(--ink3);font-size:12px}
  .chat-send-btn{width:33px;height:33px;border-radius:var(--r);border:2px solid var(--c1);background:var(--c1);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;transition:opacity .12s;color:#000}
  .chat-send-btn:hover{opacity:.8}

  /* ── PWA Install Banner ── */
  #pwa-install-banner{
    position:fixed;bottom:0;left:0;right:0;z-index:10000;
    background:var(--panel);
    border-top:3px solid var(--c1);
    padding:16px 18px 20px;
    display:flex;align-items:center;gap:14px;
    transform:translateY(100%);
    transition:transform .4s cubic-bezier(.2,.8,.4,1);
    box-shadow:0 -6px 30px rgba(0,0,0,.5);
  }
  #pwa-install-banner.show{transform:translateY(0)}
  .pwa-icon{
    width:52px;height:52px;border-radius:12px;flex-shrink:0;
    background:linear-gradient(135deg,#0d0d0f 0%,#1c1c1f 100%);
    border:2px solid var(--c1);
    display:flex;align-items:center;justify-content:center;
    box-shadow:3px 3px 0 rgba(0,255,204,.25);
    overflow:hidden;
  }
  .pwa-icon svg{width:36px;height:36px}
  .pwa-text{flex:1;min-width:0}
  .pwa-title{font-family:'Black Han Sans',sans-serif;font-size:18px;letter-spacing:2px;color:var(--ink);line-height:1}
  .pwa-sub{font-size:10px;color:var(--ink2);letter-spacing:1.5px;text-transform:uppercase;margin-top:3px;font-weight:700}
  .pwa-actions{display:flex;flex-direction:column;gap:6px;flex-shrink:0}
  .pwa-install-btn{
    background:var(--c1);color:#000;border:none;cursor:pointer;
    font-family:'Space Grotesk',sans-serif;font-weight:800;font-size:11px;
    letter-spacing:1.5px;text-transform:uppercase;
    padding:8px 16px;border-radius:6px;
    box-shadow:3px 3px 0 rgba(0,255,204,.3);
    transition:transform .1s,box-shadow .1s;white-space:nowrap;
  }
  .pwa-install-btn:hover{transform:translate(-1px,-1px);box-shadow:4px 4px 0 rgba(0,255,204,.4)}
  .pwa-install-btn:active{transform:translate(1px,1px)}
  .pwa-dismiss-btn{
    background:none;border:none;color:var(--ink3);cursor:pointer;
    font-family:'Space Grotesk',sans-serif;font-size:10px;
    letter-spacing:1px;text-transform:uppercase;font-weight:700;
    text-align:center;padding:4px;transition:color .12s;
  }
  .pwa-dismiss-btn:hover{color:var(--ink2)}
  </style>
</head>
<body>

<!-- PWA Install Banner -->
<div id="pwa-install-banner">
  <div class="pwa-icon">
    <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Board grid background -->
      <rect width="36" height="36" rx="8" fill="#0d0d0f"/>
      <!-- 5×5 mini grid (very small dots) -->
      <g opacity="0.3" fill="#00ffcc">
        <rect x="5" y="5" width="3" height="3" rx="1"/>
        <rect x="10" y="5" width="3" height="3" rx="1"/>
        <rect x="15" y="5" width="3" height="3" rx="1"/>
        <rect x="20" y="5" width="3" height="3" rx="1"/>
        <rect x="25" y="5" width="3" height="3" rx="1"/>
        <rect x="5" y="10" width="3" height="3" rx="1"/>
        <rect x="25" y="10" width="3" height="3" rx="1"/>
        <rect x="5" y="15" width="3" height="3" rx="1"/>
        <rect x="25" y="15" width="3" height="3" rx="1"/>
        <rect x="5" y="20" width="3" height="3" rx="1"/>
        <rect x="25" y="20" width="3" height="3" rx="1"/>
        <rect x="5" y="25" width="3" height="3" rx="1"/>
        <rect x="10" y="25" width="3" height="3" rx="1"/>
        <rect x="15" y="25" width="3" height="3" rx="1"/>
        <rect x="20" y="25" width="3" height="3" rx="1"/>
        <rect x="25" y="25" width="3" height="3" rx="1"/>
      </g>
      <!-- Diagonal win line — glowing gold -->
      <g fill="#ffcc00">
        <rect x="5" y="5" width="4" height="4" rx="1"/>
        <rect x="10.5" y="10.5" width="4" height="4" rx="1"/>
        <rect x="16" y="16" width="4" height="4" rx="1"/>
        <rect x="21.5" y="21.5" width="4" height="4" rx="1"/>
        <rect x="27" y="27" width="4" height="4" rx="1"/>
      </g>
      <!-- "Di" text top-left in neon mint -->
      <text x="7" y="16" font-family="Arial Black,sans-serif" font-size="8" font-weight="900" fill="#00ffcc" opacity="0.9">Di</text>
      <!-- "Go" text bottom-right in hot red -->
      <text x="20" y="32" font-family="Arial Black,sans-serif" font-size="8" font-weight="900" fill="#ff2d55" opacity="0.9">Go</text>
      <!-- Center lightning bolt star -->
      <text x="14" y="21" font-family="Arial,sans-serif" font-size="9" fill="#ffcc00">⚡</text>
    </svg>
  </div>
  <div class="pwa-text">
    <div class="pwa-title">DiNGo</div>
    <div class="pwa-sub">Add to Home Screen · Play Offline</div>
  </div>
  <div class="pwa-actions">
    <button class="pwa-install-btn" id="pwa-install-btn">⚡ Install</button>
    <button class="pwa-dismiss-btn" id="pwa-dismiss-btn">Not now</button>
  </div>
</div>

<div class="bg-grid"></div>
<canvas id="bg-canvas"></canvas>
<div class="particles" id="particles"></div>
<canvas id="confetti-canvas"></canvas>

<!-- Top UI controls -->
<button class="ui-pill" id="global-home-btn"><span class="pill-icon">🏠</span><span class="pill-label">Home</span></button>
<button class="ui-pill" id="theme-toggle"><span class="pill-icon" id="theme-icon">🌙</span><span class="pill-label">Theme</span></button>

<!-- Number Announcement -->
<div id="number-announce" style="display:none">
  <div class="announce-bubble" id="announce-bubble">
    <div class="announce-who" id="announce-who">CALLED</div>
    <div class="announce-num" id="announce-num">—</div>
    <div class="announce-sub" id="announce-sub">picks this number</div>
  </div>
</div>

<!-- Line completion flash overlay -->
<div id="line-flash"></div>

<!-- Win Overlay -->
<div id="win-overlay">
  <div class="win-title" id="win-title-text">YOU WIN!</div>
  <div class="win-subtitle" id="win-subtitle-text">Incredible performance 🎯</div>
  <div class="win-buttons">
    <button class="btn btn-gold" id="win-restart-btn">↺ &nbsp;Restart Match</button>
    <button class="btn btn-ghost" id="win-reset-btn">⏏ &nbsp;Exit</button>
  </div>
  <div class="rematch-countdown" id="rematch-countdown" style="display:none;">
    Auto-rematch in <strong id="countdown-val">10</strong>s
    <br><button class="countdown-cancel" id="countdown-cancel">Cancel</button>
  </div>
</div>


<!-- SPLASH CANVAS — live animated background -->
<canvas id="splash-canvas"></canvas>

<!-- ① WELCOME / SPLASH -->
<div id="splash-screen" class="screen active">
  <div class="card">
    <div class="card-body" style="padding:40px 28px 44px">

      <!-- Live badge -->
      <div class="splash-top-badge">
        <span class="badge-live-dot"></span>
        Live Multiplayer · Real-time
      </div>

      <!-- Logo + rings -->
      <div class="splash-logo-wrap">
        <div class="splash-ring ring1"></div>
        <div class="splash-ring ring2"></div>
        <div class="splash-ring ring3"></div>
        <div class="splash-ring ring4"></div>
        <span class="splash-logo">DiNGo</span>
      </div>

      <p class="splash-tagline">5 in a row · first to win</p>
      <p class="splash-game-sub">The Arena Awaits</p>

      <p class="splash-desc">
        Place your numbers. Call the shots.<br>
        <strong>First to 5 lines</strong> claims the arena.
      </p>

      <!-- Live stats row -->
      <div class="splash-stats">
        <div class="splash-stat">
          <span class="splash-stat-num">5×5</span>
          <span class="splash-stat-label">Grid</span>
        </div>
        <div class="splash-stat-divider"></div>
        <div class="splash-stat">
          <span class="splash-stat-num">3</span>
          <span class="splash-stat-label">AI Levels</span>
        </div>
        <div class="splash-stat-divider"></div>
        <div class="splash-stat">
          <span class="splash-stat-num">∞</span>
          <span class="splash-stat-label">Rematches</span>
        </div>
      </div>

      <!-- Enter button -->
      <button class="btn-splash-enter" id="enter-arena-btn">
        <span class="btn-enter-icon">⚡</span>
        Enter the Arena
      </button>

      <p class="splash-micro">No account needed · Instant play</p>

    </div>
  </div>
</div>


<!-- ② NAME ENTRY -->
<div id="name-screen" class="screen">
  <div class="card">
    <div class="card-body">
      <div class="screen-logo">DiNGo</div>
      <p class="screen-sub">Choose your identity</p>

      <p class="field-label">Pick an avatar</p>
      <div class="avatar-grid" id="avatar-row"></div>

      <p class="field-label">Pick your colour</p>
      <div class="color-strip" id="color-row"></div>

      <p class="field-label">Your name</p>
      <input type="text" id="player-name-input" maxlength="14" placeholder="e.g. Nova, Ace, Zara…" style="margin-bottom:20px"/>

      <button class="btn btn-primary btn-full" id="name-confirm-btn">→ &nbsp;Continue to Lobby</button>
    </div>
  </div>
</div>


<!-- ③ HOME / LOBBY — Hardware Aesthetic v4 -->
<div id="home-screen" class="screen">
  <div class="card" style="max-width:480px">

    <!-- Animated grid background -->
    <div class="home-grid-bg">
      <canvas class="home-grid-canvas" id="home-grid-canvas"></canvas>
    </div>
    <!-- Hardware scan lines -->
    <div class="scanlines"></div>

    <div class="card-body" style="position:relative;z-index:3">

      <!-- ① PROFILE STRIP -->
      <div class="home-profile-strip">
        <div class="home-avatar-wrap">
          <div class="home-avatar" id="home-avatar-display">👹</div>
          <div class="home-rank-badge" id="home-rank-badge">ARENA</div>
        </div>
        <div class="home-profile-info">
          <div class="home-username" id="home-username-display">Player</div>
          <div class="home-rank-label">⚡ Ready to dominate</div>
        </div>
        <div class="home-profile-nodes">
          <div class="node-dot"></div>
          <div class="node-dot"></div>
          <div class="node-dot"></div>
        </div>
      </div>

      <!-- ② EVENT BANNERS CAROUSEL -->
      <div class="home-banners" id="home-banners">
        <div class="banner-slide banner-rush active">
          <div class="banner-icon">⚡</div>
          <div class="banner-text">
            <div class="banner-title" style="color:var(--gold)">Weekend Rush: Double Points</div>
            <div class="banner-sub">Diagonal wins count double this weekend!</div>
          </div>
        </div>
        <div class="banner-slide banner-event">
          <div class="banner-icon">🎯</div>
          <div class="banner-text">
            <div class="banner-title" style="color:var(--cyan)">Clutch Mode Unlocked</div>
            <div class="banner-sub">Win 3 in a row to earn the Clutch title</div>
          </div>
        </div>
        <div class="banner-slide banner-skin">
          <div class="banner-icon">💎</div>
          <div class="banner-text">
            <div class="banner-title" style="color:var(--pink)">New Neon Board Skin</div>
            <div class="banner-sub">Unlock it in the Store — limited time!</div>
          </div>
        </div>
        <div class="banner-dots">
          <div class="banner-dot active" data-idx="0"></div>
          <div class="banner-dot" data-idx="1"></div>
          <div class="banner-dot" data-idx="2"></div>
        </div>
      </div>

      <!-- ③ DAILY CLUTCH PUZZLE -->
      <div class="home-puzzle-section" id="home-puzzle-section">
        <div class="puzzle-header">
          <span class="puzzle-label">🧩 Daily Clutch Puzzle</span>
          <span class="puzzle-timer" id="puzzle-timer">Loading…</span>
        </div>
        <div class="puzzle-mini-board" id="puzzle-mini-board"></div>
        <p class="puzzle-cta" id="puzzle-cta">Find the one move that completes a BINGO line →</p>
        <div class="puzzle-result" id="puzzle-result" style="display:none"></div>
      </div>

      <!-- ④ GLOBAL LOBBY CHAT -->
      <div class="home-lobby-chat">
        <div class="lobby-chat-header">
          <span class="lobby-chat-label">
            <span class="lobby-live-dot"></span>
            Global Lobby
          </span>
          <span class="lobby-chat-count" id="lobby-chat-count">Live chat</span>
        </div>
        <div class="lobby-messages" id="lobby-messages">
          <div class="lobby-msg">
            <span class="lobby-msg-avatar">👾</span>
            <span class="lobby-msg-name">Nova:</span>
            <span class="lobby-msg-text">anyone up for a match? 🔥</span>
          </div>
          <div class="lobby-msg">
            <span class="lobby-msg-avatar">🦊</span>
            <span class="lobby-msg-name">Ace:</span>
            <span class="lobby-msg-text">5 lines or bust 😤</span>
          </div>
          <div class="lobby-msg">
            <span class="lobby-msg-avatar">🐉</span>
            <span class="lobby-msg-name">Zara:</span>
            <span class="lobby-msg-text">gg everyone good luck today!</span>
          </div>
        </div>
      </div>

      <!-- ⑤ ACTION ZONE -->
      <div class="home-action-zone">
        <!-- PLAY NOW mega button -->
        <button class="btn-play-now" id="play-now-btn">
          <span class="play-now-icon">⚡</span>
          PLAY NOW
        </button>

        <!-- VS BOT button -->
        <button class="btn-vs-bot" id="vs-bot-btn">
          <span class="bot-icon">🤖</span>
          Play vs AI Bot
        </button>

        <!-- Private match row -->
        <div class="home-private-row">
          <button id="create-btn" class="btn btn-ghost">＋ Create Room</button>
          <button id="join-btn-toggle" class="btn btn-ghost">🔗 Join with Code</button>
        </div>

        <!-- Join row (hidden by default) -->
        <div class="join-row" id="join-row" style="display:none;margin-top:8px">
          <input id="room-code-input" type="text" maxlength="4" placeholder="Room code e.g. A3K9"/>
          <button id="join-btn" class="btn btn-primary">Join</button>
        </div>

        <!-- How to play link -->
        <div style="text-align:center;margin-top:10px">
          <button id="htp-btn" style="background:none;border:none;cursor:pointer;font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink3);display:inline-flex;align-items:center;gap:5px;padding:4px 8px;border-radius:4px;transition:color .12s">
            <span style="font-size:13px">❓</span> How to Play
          </button>
        </div>
      </div>

      <p id="home-msg"></p>

      <!-- Firebase connection status -->
      <div id="firebase-status" style="display:none;text-align:center;font-size:11px;letter-spacing:1px;padding:8px 12px;border-radius:10px;margin-top:8px;font-weight:600"></div>

      <!-- Firebase rules help (shown on permission error) -->
      <div id="firebase-rules-help" style="display:none;margin-top:10px;background:rgba(255,209,102,0.08);border:1px solid rgba(255,209,102,0.25);border-radius:12px;padding:12px 14px;font-size:11px;line-height:1.7;color:var(--text2)">
        <div style="color:var(--gold);font-weight:800;letter-spacing:1px;margin-bottom:6px">🔧 FIX: Firebase Rules</div>
        Go to <strong style="color:var(--cyan)">Firebase Console → Realtime Database → Rules</strong> and paste:<br>
        <code style="display:block;margin-top:6px;padding:8px;background:rgba(0,0,0,0.3);border-radius:8px;color:var(--green);font-size:10px;letter-spacing:.3px">{ "rules": { ".read": true, ".write": true } }</code>
        <span style="color:var(--muted);font-size:10px">⚠️ For development only — add auth rules for production</span>
      </div>
    </div>
  </div>
</div>


<!-- ④ SETUP -->
<div id="setup-screen" class="screen">
  <div class="card">
    <div class="card-body">
      <div class="room-badge">
        <div>
          <div class="room-badge-label">Room Code</div>
          <div class="room-badge-code" id="display-room-code">——</div>
          <div class="waiting-dots">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            <span id="waiting-label">Waiting for opponent</span>
          </div>
        </div>
      </div>
      <div class="section-title">Arrange Your Board</div>
      <p class="section-sub">Tap cells to place 1→25 in any order, or shuffle randomly.</p>
      <div class="progress-bar"><div class="progress-fill" id="setup-progress"></div></div>
      <div class="setup-actions">
        <button class="btn btn-ghost" id="home-from-setup">🏠 Home</button>
        <button class="btn btn-ghost" id="shuffle-btn">🔀 Random</button>
        <button class="btn btn-ghost" id="clear-btn">✕ Clear</button>
      </div>
      <div class="board-wrap"><div class="board" id="setup-board"></div></div>
      <button id="ready-btn" class="btn btn-pink btn-full" disabled>✓ &nbsp;I'm Ready!</button>
    </div>
  </div>
</div>


<!-- ⑤ GAME -->
<div id="game-screen" class="screen">
  <div class="card">
    <div class="card-body">

      <!-- Score bar -->
      <div class="score-bar">
        <div class="score-chip">
          <div class="score-num c1" id="score-p1">0</div>
          <div class="score-lbl">You</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
          <div class="vs-dot">:</div>
          <span class="ai-mode-pill" id="ai-mode-pill">AI</span>
        </div>
        <div class="score-chip">
          <div class="score-num c2" id="score-p2">0</div>
          <div class="score-lbl">Bot</div>
        </div>
      </div>

      <!-- Player boxes with live status message -->
      <div class="players-row">
        <div class="player-box p1" id="p1-box">
          <span class="player-avatar" id="p1-avatar">🎮</span>
          <div class="player-info">
            <div class="player-label">Player 1</div>
            <div class="player-name" id="p1-name">—</div>
            <div class="player-status" id="p1-status"></div>
          </div>
        </div>
        <div class="vs-badge">VS</div>
        <div class="player-box p2" id="p2-box">
          <span class="player-avatar" id="p2-avatar">🕹️</span>
          <div class="player-info" style="text-align:right">
            <div class="player-label">Player 2</div>
            <div class="player-name" id="p2-name">—</div>
            <div class="player-status" id="p2-status"></div>
          </div>
        </div>
      </div>

      <div id="turn-indicator">Loading…</div>
      <div id="ai-thinking-bar">
        <span class="think-dot"></span><span class="think-dot"></span><span class="think-dot"></span>
        AI is thinking…
      </div>

      <div class="board-wrap"><div class="board" id="game-board"></div></div>

      <div class="action-row">
        <button class="btn btn-ghost" id="home-from-game">🏠 Home</button>
        <button class="btn btn-gold" id="restart-btn">↺ Restart</button>
        <button class="btn btn-ghost" id="reset-btn">⏏ Exit</button>
      </div>
    </div>
  </div>
</div>


<!-- ── HOW TO PLAY MODAL ── -->
<div id="htp-modal">
  <div class="htp-card">
    <div class="htp-header">
      <div class="htp-title">HOW TO PLAY</div>
      <button class="htp-close" id="htp-close-btn">✕</button>
    </div>
    <div class="htp-body">

      <div class="htp-step">
        <div class="htp-step-num">1</div>
        <div class="htp-step-text">
          <strong>Build your board.</strong> You get a blank 5×5 grid. Tap cells to fill them with numbers 1–25 in any order you like, or hit <strong>Random</strong> to shuffle instantly. Your arrangement is your secret weapon.
        </div>
      </div>

      <div class="htp-step">
        <div class="htp-step-num">2</div>
        <div class="htp-step-text">
          <strong>Take turns calling numbers.</strong> Each player picks one uncalled number per turn. When a number is called, every player who has it on their board crosses it out automatically.
        </div>
      </div>

      <div class="htp-step">
        <div class="htp-step-num">3</div>
        <div class="htp-step-text">
          <strong>Complete 5 in a row to score a line.</strong> A line can run horizontally, vertically, or diagonally — any direction counts. Watch all three directions!
          <!-- Mini demo board -->
          <div class="htp-win-demo" id="htp-demo-board"></div>
          <span class="htp-tag gold">Row ✓</span>
          <span class="htp-tag gold" style="margin-left:4px">Column ✓</span>
          <span class="htp-tag gold" style="margin-left:4px">Diagonal ✓</span>
        </div>
      </div>

      <div class="htp-step">
        <div class="htp-step-num">4</div>
        <div class="htp-step-text">
          <strong>First to 5 lines wins the match.</strong> Every completed line glows gold on your board. Stack lines fast — your opponent is racing you.
          <br><span class="htp-tag green" style="margin-top:6px">5 Lines = WIN</span>
        </div>
      </div>

      <div class="htp-step">
        <div class="htp-step-num">5</div>
        <div class="htp-step-text">
          <strong>Strategy tip:</strong> Numbers near the center of your board belong to more lines (rows + columns + both diagonals), so placing small, easy-to-call numbers in the center gives you the fastest path to 5 lines.
          <br><span class="htp-tag red" style="margin-top:6px">Center = More Lines</span>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ── ABANDON COUNTDOWN BANNER ── -->
<div id="abandon-banner">
  <span class="abandon-icon">🏃</span>
  <div class="abandon-text">Opponent left! You win in <strong id="abandon-timer">60</strong>s</div>
</div>

<!-- AI DIFFICULTY SELECTION MODAL -->
<div id="ai-difficulty-modal">
  <div class="diff-card">
    <div class="diff-title">VS AI BOT</div>
    <p class="diff-sub">Choose your opponent's difficulty</p>

    <div class="diff-option" data-level="easy">
      <span class="diff-emoji">🎲</span>
      <div class="diff-info">
        <div class="diff-name" style="color:var(--green)">Easy</div>
        <div class="diff-desc">Plays randomly. Great for learning the ropes or warming up.</div>
      </div>
      <span class="diff-badge badge-easy">CHILL</span>
    </div>

    <div class="diff-option" data-level="medium">
      <span class="diff-emoji">🛡️</span>
      <div class="diff-info">
        <div class="diff-name" style="color:var(--gold)">Medium</div>
        <div class="diff-desc">Blocks your wins and grabs its own. Plays to defend.</div>
      </div>
      <span class="diff-badge badge-medium">FAIR</span>
    </div>

    <div class="diff-option" data-level="hard">
      <span class="diff-emoji">🧠</span>
      <div class="diff-info">
        <div class="diff-name" style="color:var(--pink)">Hard</div>
        <div class="diff-desc">Heuristic AI. Scores every cell and hunts for traps. Good luck.</div>
      </div>
      <span class="diff-badge badge-hard">PRO</span>
    </div>

    <button class="diff-cancel" id="diff-cancel-btn">✕ Cancel</button>
  </div>
</div>


<!-- CHAT FAB + PANEL -->
<button class="chat-fab" id="chat-fab" style="display:none;">
  💬
  <div class="chat-badge" id="chat-badge"></div>
</button>
<div class="chat-panel" id="chat-panel">
  <div class="chat-header">💬 &nbsp;Chat</div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-emojis" id="chat-emojis"></div>
  <div class="chat-input-row">
    <input type="text" class="chat-text-input" id="chat-text-input" placeholder="Type a message…" maxlength="80"/>
    <button class="chat-send-btn" id="chat-send-btn">➤</button>
  </div>
</div>


<!-- ═══════════════════════════════════════════════
     PLAIN SCRIPT — instant UI, no Firebase dependency
═══════════════════════════════════════════════ -->
<script>
/* ── Screen transitions ───────────────────────────────────────── */
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(name + '-screen').classList.add('active');
  // Hide global home pill on splash and home (no point going home from home)
  document.getElementById('global-home-btn').style.display =
    (name === 'splash' || name === 'home') ? 'none' : 'flex';
}

/* ── Theme toggle ─────────────────────────────────────────────── */
let isLight = false;
document.getElementById('theme-toggle').addEventListener('click', () => {
  isLight = !isLight;
  document.body.classList.toggle('light', isLight);
  document.getElementById('theme-icon').textContent  = isLight ? '☀️' : '🌙';
});

/* ── Global home pill ─────────────────────────────────────────── */
document.getElementById('global-home-btn').addEventListener('click', () => {
  showScreen('home');
  document.getElementById('chat-fab').style.display = 'none';
  document.getElementById('chat-panel').classList.remove('open');
  document.getElementById('win-overlay').classList.remove('show');
});

/* ── In-card home buttons ─────────────────────────────────────── */
document.getElementById('home-from-setup').addEventListener('click', () => {
  leaveRoomCleanup();
  showScreen('home');
  document.getElementById('chat-fab').style.display = 'none';
  document.getElementById('chat-panel').classList.remove('open');
});
/* home-from-game is handled in the Firebase module with bot-mode support */

/* ── Enter arena ──────────────────────────────────────────────── */
document.getElementById('enter-arena-btn').addEventListener('click', () => showScreen('name'));






/* ── Shared player data (read by Firebase module script) ─────── */
window.DINGO = { selectedAvatar:'👹', selectedColor:'#00e5ff', playerName:'Player' };

/* ══════════════════════════════════════════
   HOME SCREEN — Hardware UI upgrades
══════════════════════════════════════════ */

/* Update profile strip when entering home */
function refreshHomeProfile() {
  const d = window.DINGO;
  document.getElementById('home-avatar-display').textContent = d.selectedAvatar || '👹';
  document.getElementById('home-username-display').textContent = d.playerName || 'Player';
  // Give a fun rank label
  const ranks = ['ARENA','CLUTCH','ELITE','BEAST','LEGEND'];
  document.getElementById('home-rank-badge').textContent = ranks[Math.floor(Math.random()*ranks.length)];
}



let homeGridCleanup = null; function initHomeGrid(){return null;}

// Patch showScreen to run home setup
const _origShowScreen = window.showScreen || function(){};
// We'll hook into the name-confirm to also refresh profile
document.getElementById && document.addEventListener('DOMContentLoaded', ()=>{}, false);

/* Banner carousel */
(function initBanners() {
  const slides = document.querySelectorAll('.banner-slide');
  const dots   = document.querySelectorAll('.banner-dot');
  let cur = 0;
  function go(i) {
    slides[cur].classList.remove('active');
    dots[cur].classList.remove('active');
    cur = (i + slides.length) % slides.length;
    slides[cur].classList.add('active');
    dots[cur].classList.add('active');
  }
  setInterval(() => go(cur + 1), 3500);
  dots.forEach(d => d.addEventListener('click', () => go(+d.dataset.idx)));
})();

/* ══════════════════════════════════════
   DAILY CLUTCH PUZZLE — fully functional
   • Deterministic daily board via date-seeded PRNG
   • 4 cells already "called", 1 mystery cell completes a BINGO line
   • Remaining 20 cells are decoys (clickable but wrong)
   • State persisted in localStorage (one attempt per calendar day)
══════════════════════════════════════ */
(function initDailyPuzzle() {

  /* ── Simple seeded PRNG (mulberry32) ── */
  function seeded(seed) {
    return function() {
      seed |= 0; seed = seed + 0x6D2B79F5 | 0;
      let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
      t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    };
  }

  /* ── Date seed: unique per calendar day ── */
  function dateKey() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
  }

  function hashStr(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) { h = (Math.imul(31, h) + s.charCodeAt(i)) | 0; }
    return Math.abs(h);
  }

  /* ── Shuffle array using a PRNG ── */
  function shuffle(arr, rng) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(rng() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  /* ── All 12 line definitions for a 5×5 grid ── */
  const ALL_LINES = [];
  for (let r = 0; r < 5; r++) { const b = r*5; ALL_LINES.push([b,b+1,b+2,b+3,b+4]); }
  for (let c = 0; c < 5; c++) { ALL_LINES.push([c,c+5,c+10,c+15,c+20]); }
  ALL_LINES.push([0,6,12,18,24], [4,8,12,16,20]);

  /* ── Generate today's puzzle ── */
  function generatePuzzle() {
    const rng    = seeded(hashStr(dateKey()));
    const nums   = shuffle(Array.from({length:25},(_,i)=>i+1), rng); // board numbers 1–25
    const line   = ALL_LINES[Math.floor(rng() * ALL_LINES.length)];  // pick a random line
    const ansIdx = line[Math.floor(rng() * 5)];                      // which index is the mystery cell

    // The 4 "already called" cells are the rest of the chosen line
    const called  = line.filter(i => i !== ansIdx);
    const answer  = ansIdx;  // board-index of the winning move

    return { nums, called, answer };
  }

  /* ── Render the puzzle ── */
  function render() {
    const board   = document.getElementById('puzzle-mini-board');
    const cta     = document.getElementById('puzzle-cta');
    const result  = document.getElementById('puzzle-result');
    if (!board) return;

    const today   = dateKey();
    const saved   = (() => { try { return JSON.parse(localStorage.getItem('dingo_puzzle')||'null'); } catch(e){return null;} })();
    const { nums, called, answer } = generatePuzzle();

    board.innerHTML = '';
    result.style.display = 'none';

    /* ── Already solved today ── */
    if (saved && saved.date === today) {
      cta.textContent = '✅ Puzzle complete — come back tomorrow!';
      nums.forEach((n, i) => {
        const cell = document.createElement('div');
        const wasAnswer  = (i === answer);
        const wasCalled  = called.includes(i);
        cell.className = 'puzzle-cell ' + (wasAnswer ? 'done-answer' : wasCalled ? 'done-filled' : '');
        cell.textContent = n;
        board.appendChild(cell);
      });
      result.className = 'puzzle-result done';
      result.textContent = saved.won ? '🎯 You nailed it! +10 XP' : `😅 The answer was: ${nums[answer]}`;
      result.style.display = 'block';
      return;
    }

    /* ── Active puzzle ── */
    cta.textContent = 'Tap the ONE uncalled number that completes a BINGO line →';
    let attempted = false;

    nums.forEach((n, i) => {
      const cell = document.createElement('div');
      const isCalled = called.includes(i);

      if (isCalled) {
        cell.className = 'puzzle-cell filled';
        cell.textContent = n;
      } else {
        // Every uncalled cell is clickable (mystery cells + decoys)
        cell.className = 'puzzle-cell clickable';
        cell.textContent = n;
        cell.addEventListener('click', () => {
          if (attempted) return;
          attempted = true;

          if (i === answer) {
            // ✅ Correct!
            cell.className = 'puzzle-cell correct';
            sfx && sfx.win && sfx.win();
            result.className = 'puzzle-result win';
            result.textContent = '🎯 Correct! You found the BINGO move!';
            result.style.display = 'block';
            cta.textContent = '🏆 Perfect solve!';
            localStorage.setItem('dingo_puzzle', JSON.stringify({date:today, won:true}));
            // Light up the full winning line
            ALL_LINES.forEach(line => {
              if (line.includes(answer)) {
                const allInLine = line.every(idx => called.includes(idx) || idx === answer);
                if (allInLine) {
                  line.forEach(idx => {
                    const el = board.children[idx];
                    if (el) { el.className = 'puzzle-cell revealed-win'; }
                  });
                }
              }
            });
          } else {
            // ❌ Wrong
            cell.className = 'puzzle-cell wrong';
            setTimeout(() => { cell.className = 'puzzle-cell clickable'; attempted = false; }, 400);
            sfx && sfx.lose && sfx.lose();
          }
        });
      }
      board.appendChild(cell);
    });
  }

  /* ── Countdown timer to midnight ── */
  function updatePuzzleTimer() {
    const now = new Date();
    const mdn = new Date(); mdn.setHours(24,0,0,0);
    const diff = Math.max(0, Math.floor((mdn - now) / 1000));
    const h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60);
    const el = document.getElementById('puzzle-timer');
    if (el) el.textContent = `Resets in ${h}h ${m}m`;
  }

  render();
  updatePuzzleTimer();
  setInterval(updatePuzzleTimer, 60000);

  // Prevent accidental navigation when clicking on the section header
  document.getElementById('home-puzzle-section').addEventListener('click', e => {
    if (e.target.classList.contains('puzzle-cell') || e.target.classList.contains('home-puzzle-section')) return;
    // Allow bubbling only from non-cell clicks (for the border flash)
    if (navigator.vibrate) navigator.vibrate([20, 5, 20]);
  });
})();

/* Join toggle */
document.getElementById('join-btn-toggle').addEventListener('click', () => {
  const row = document.getElementById('join-row');
  const visible = row.style.display !== 'none';
  row.style.display = visible ? 'none' : 'flex';
  if (!visible) document.getElementById('room-code-input').focus();
});

/* ── How to Play modal ─────────────────────────── */
(function initHTP() {
  // Build the mini demo board: a 5×5 showing a diagonal win line
  const demo = document.getElementById('htp-demo-board');
  // Layout: indices 0,6,12,18,24 are the diagonal win line; some others are crossed
  const crossed  = new Set([1,5,7,10,15,20]);
  const winLine  = new Set([0,6,12,18,24]);
  const nums = [7,14,3,19,5, 23,8,2,11,21, 16,25,6,17,9, 4,12,22,13,24, 18,1,15,20,10];
  nums.forEach((n, i) => {
    const cell = document.createElement('div');
    cell.className = 'htp-cell' + (winLine.has(i) ? ' win' : crossed.has(i) ? ' cx' : '');
    cell.textContent = n;
    demo.appendChild(cell);
  });

  const modal   = document.getElementById('htp-modal');
  const openBtn = document.getElementById('htp-btn');
  const closeBtn= document.getElementById('htp-close-btn');

  openBtn.addEventListener('click', () => {
    modal.classList.add('show');
    if (navigator.vibrate) navigator.vibrate(20);
  });
  closeBtn.addEventListener('click', () => modal.classList.remove('show'));
  modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('show'); });
})();

/* ── VS Bot button — opens difficulty modal ───── */
document.getElementById('vs-bot-btn').addEventListener('click', () => {
  if (navigator.vibrate) navigator.vibrate(30);
  document.getElementById('ai-difficulty-modal').classList.add('show');
});
document.getElementById('diff-cancel-btn').addEventListener('click', () => {
  document.getElementById('ai-difficulty-modal').classList.remove('show');
});
// Difficulty selection — dispatches a custom event picked up by the Firebase module
document.querySelectorAll('.diff-option').forEach(opt => {
  opt.addEventListener('click', () => {
    const level = opt.dataset.level;
    if (navigator.vibrate) navigator.vibrate([30, 10, 30]);
    document.getElementById('ai-difficulty-modal').classList.remove('show');
    document.dispatchEvent(new CustomEvent('startBotGame', { detail: { level } }));
  });
});

/* Haptic on create / play now */
function haptic(pattern) { if (navigator.vibrate) navigator.vibrate(pattern); }

/* Start home grid when screen shown */
const origShowScreenRef = showScreen;
window.showScreen = function(name) {
  origShowScreenRef(name);
  if (name === 'home') {
    refreshHomeProfile();
    /* homeGrid removed */
    // Reload lobby chat placeholders with a random shuffle each time
    rotateLobbyMessages();
  }
};

/* Lobby chat placeholder messages */
const LOBBY_FAKE = [
  {a:'👹',n:'Ryze',t:'anyone wanna get destroyed? 😈'},
  {a:'🦊',n:'Nova',t:'just hit 5 lines on my first game!!'},
  {a:'🤖',n:'XR7',t:'looking for a match 🎯'},
  {a:'🐉',n:'Zara',t:'this game is so addictive omg'},
  {a:'💎',n:'Prism',t:'gg wp last round, good luck all'},
  {a:'⚡',n:'Bolt',t:'5 lines let\'s goooo 🔥'},
  {a:'🌙',n:'Luna',t:'anyone else play daily puzzles?'},
  {a:'🎯',n:'Ace',t:'room code: A3K9 — join me!'},
];
function rotateLobbyMessages() {
  const container = document.getElementById('lobby-messages');
  if (!container) return;
  container.innerHTML = '';
  const pool = [...LOBBY_FAKE].sort(() => Math.random()-.5).slice(0,3);
  pool.forEach(({a,n,t}) => {
    const div = document.createElement('div');
    div.className = 'lobby-msg';
    div.innerHTML = `<span class="lobby-msg-avatar">${a}</span><span class="lobby-msg-name">${n}:</span><span class="lobby-msg-text">${t}</span>`;
    container.appendChild(div);
  });
  document.getElementById('lobby-chat-count').textContent = `${Math.floor(Math.random()*12)+3} online`;
}

const AVATARS = ['👹','😘','🦊','🐉','👾','🤖','🦋','🔥','⚡','🌙','💎','🎯'];
const COLORS  = [
  {val:'#00e5ff',label:'Cyan'},{val:'#ff3cac',label:'Pink'},
  {val:'#06ffa5',label:'Green'},{val:'#ffd166',label:'Gold'},
  {val:'#a78bfa',label:'Purple'},{val:'#ff6b6b',label:'Red'},
];

/* Render avatar grid */
const avatarRow = document.getElementById('avatar-row');
AVATARS.forEach((a, i) => {
  const el = document.createElement('div');
  el.className = 'avatar-opt' + (i === 0 ? ' selected' : '');
  el.textContent = a;
  el.addEventListener('click', () => {
    document.querySelectorAll('.avatar-opt').forEach(x => x.classList.remove('selected'));
    el.classList.add('selected');
    window.DINGO.selectedAvatar = a;
  });
  avatarRow.appendChild(el);
});

/* Render colour swatches */
const colorRow = document.getElementById('color-row');
COLORS.forEach((c, i) => {
  const sw = document.createElement('div');
  sw.className = 'color-swatch' + (i === 0 ? ' selected' : '');
  sw.style.background = c.val;
  sw.title = c.label;
  sw.addEventListener('click', () => {
    document.querySelectorAll('.color-swatch').forEach(x => x.classList.remove('selected'));
    sw.classList.add('selected');
    window.DINGO.selectedColor = c.val;
  });
  colorRow.appendChild(sw);
});

/* Continue to lobby */
document.getElementById('name-confirm-btn').addEventListener('click', () => {
  const v = document.getElementById('player-name-input').value.trim();
  window.DINGO.playerName = v || 'Player';
  showScreen('home');
  // Refresh profile strip immediately
  if (typeof refreshHomeProfile === 'function') refreshHomeProfile();
});
document.getElementById('player-name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('name-confirm-btn').click();
});
</script>


<!-- ═══════════════════════════════════════════════
     FIREBASE MODULE SCRIPT — all game logic
═══════════════════════════════════════════════ -->
<script>
const app = firebase.initializeApp({
  apiKey:            "AIzaSyAhhGzyMUJrfzYsOw4Uy-qu6F_IOqrh3PA",
  authDomain:        "dingo-v2-0.firebaseapp.com",
  databaseURL:       "https://dingo-v2-0-default-rtdb.firebaseio.com",
  projectId:         "dingo-v2-0",
  storageBucket:     "dingo-v2-0.firebasestorage.app",
  messagingSenderId: "908358383631",
  appId:             "1:908358383631:web:09473d12f079a230134b7a",
  measurementId:     "G-MFTX32JEDJ"
});
const db = firebase.database();

/* helper shims so the rest of the code works unchanged */
/* Fix: the codebase uses the modular SDK signature ref(db, 'path'),
   so we detect which style is being used and handle both.
   When called as ref(db, 'rooms/foo'), dbOrPath is the DB object
   and path is the string we actually want. When called as ref('rooms/foo'),
   dbOrPath is already the string path. */
function ref(dbOrPath, path)    { return db.ref(path !== undefined ? path : dbOrPath); }
function get(r)                 { return r.get(); }
function set(r, v)              { return r.set(v); }
function update(r, v)           { return r.update(v); }
function onValue(r, cb)         { r.on('value', cb); }
function push(r, v)             { return r.push(v); }

/* ── Firebase connection health check ─────────── */
function setFirebaseStatus(ok, msg) {
  const el = document.getElementById('firebase-status');
  if (!el) return;
  el.style.display = 'block';
  el.textContent   = msg;
  if (ok) {
    el.style.background = 'rgba(6,255,165,0.1)';
    el.style.border     = '1px solid rgba(6,255,165,0.3)';
    el.style.color      = '#06ffa5';
    setTimeout(() => { el.style.display = 'none'; }, 3000);
  } else {
    el.style.background = 'rgba(255,60,172,0.12)';
    el.style.border     = '1px solid rgba(255,60,172,0.4)';
    el.style.color      = '#ff3cac';
  }
}

// Test Firebase connection using .info/connected
onValue(ref(db, '.info/connected'), snap => {
  if (snap.val() === true) {
    setFirebaseStatus(true, '✅ Connected to server');
  } else {
    setFirebaseStatus(false, '⚠️ Not connected — check your internet');
  }
});

/* ── Game state ───────────────────────────────── */
let myPlayerId   = Math.random().toString(36).substring(2,9);
let roomId       = "";
let playerRole   = "";
let myBoard      = [];
let setupCounter = 1;
let chatOpen     = false;
let winShown     = false;
let countdownInterval = null;
let scores = { p1:0, p2:0 };
/* Player identity — read fresh from window.DINGO at create/join time */
let playerName   = 'Player';
let playerAvatar = '👹';
let playerColor  = '#00e5ff';

/* ═══════════════════════════════════════════════
   SOUND ENGINE
═══════════════════════════════════════════════ */
let audioCtx = null;
function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playTone(notes, type='sine', vol=0.18) {
  try {
    const ctx = getAudio();
    notes.forEach(([freq,start,dur]) => {
      const osc=ctx.createOscillator(), gain=ctx.createGain();
      osc.type=type;
      osc.frequency.setValueAtTime(freq, ctx.currentTime+start);
      gain.gain.setValueAtTime(vol, ctx.currentTime+start);
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+start+dur);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(ctx.currentTime+start);
      osc.stop(ctx.currentTime+start+dur+0.05);
    });
  } catch(e) {}
}
const sfx = {
  click:    ()=>playTone([[880,0,0.08]],'sine',0.12),
  cross:    ()=>playTone([[300,0,0.06],[200,0.04,0.1]],'triangle',0.2),
  win:      ()=>playTone([[523,0,.12],[659,.1,.12],[784,.2,.12],[1047,.3,.3],[1319,.45,.5]],'sine',0.22),
  lose:     ()=>playTone([[392,0,.12],[349,.12,.12],[294,.24,.25]],'triangle',0.18),
  ping:     ()=>playTone([[1200,0,.07],[900,.07,.12]],'sine',0.1),
  announce: ()=>playTone([[660,0,.06],[880,.06,.12]],'sine',0.15),
};

/* ═══════════════════════════════════════════════
   AI BOT ENGINE — runs entirely locally, no Firebase
═══════════════════════════════════════════════ */

// ── Shared bot game state ──
let botMode       = false;   // true when playing vs AI
let botLevel      = 'easy';  // 'easy' | 'medium' | 'hard'
let botBoard      = [];      // AI's 5×5 board layout (numbers 1-25)
let playerBotBoard= [];      // Player's 5×5 board layout
let botSelected   = [];      // numbers called so far in bot game
let botScores     = {player:0, bot:0};
let botWinShown   = false;
let botCountdownInterval = null;
const BOT_AVATARS = {easy:'🎲', medium:'🛡️', hard:'🧠'};
const BOT_NAMES   = {easy:'ChillBot', medium:'DefendBot', hard:'ProBot'};

/* ── Generate a random shuffled board ── */
function genRandomBoard() {
  const nums = Array.from({length:25}, (_,i) => i+1);
  for (let i = nums.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [nums[i],nums[j]] = [nums[j],nums[i]];
  }
  return nums;
}

/* ─── Check win lines for a board & selected set ─── */
function botCheckLines(board, selected) {
  const hits = board.map(n => selected.includes(n) ? 1 : 0);
  let lines = 0; const winIdx = new Set();
  for (let r=0;r<5;r++){const b=r*5,row=[b,b+1,b+2,b+3,b+4];if(row.every(i=>hits[i])){row.forEach(i=>winIdx.add(i));lines++}}
  for (let c=0;c<5;c++){const col=[c,c+5,c+10,c+15,c+20];if(col.every(i=>hits[i])){col.forEach(i=>winIdx.add(i));lines++}}
  [[0,6,12,18,24],[4,8,12,16,20]].forEach(d=>{if(d.every(i=>hits[i])){d.forEach(i=>winIdx.add(i));lines++}});
  return { lines, winIdx };
}

/* ─── Count consecutive pieces in a line ─── */
function countLine(board, selected, indices) {
  return indices.filter(i => selected.includes(board[i])).length;
}
function isLineOpen(board, selected, indices) {
  // True if the line has no opponent pieces blocking (all cells are either selected or empty)
  return indices.every(i => selected.includes(board[i]) || !selected.includes(board[i]));
}

/* ═══════════════════════════════════════════════
   AI MOVE CALCULATORS
═══════════════════════════════════════════════ */

/* LEVEL 1 — Easy: pure random */
function aiMoveEasy(calledNums) {
  const available = Array.from({length:25}, (_,i)=>i+1).filter(n=>!calledNums.includes(n));
  return available[Math.floor(Math.random()*available.length)];
}

/* LEVEL 2 — Medium: Win > Block > Random near pieces */
function aiMoveMedium(calledNums, playerBoard, botBrd) {
  const ALL_LINES = [];
  for(let r=0;r<5;r++){const b=r*5;ALL_LINES.push([b,b+1,b+2,b+3,b+4])}
  for(let c=0;c<5;c++){ALL_LINES.push([c,c+5,c+10,c+15,c+20])}
  ALL_LINES.push([0,6,12,18,24],[4,8,12,16,20]);

  const available = Array.from({length:25},(_,i)=>i+1).filter(n=>!calledNums.includes(n));

  // Rule 1: Win — find a number that completes 5 on bot's board
  for (const line of ALL_LINES) {
    const vals = line.map(i => botBrd[i]);
    const uncalled = vals.filter(v => !calledNums.includes(v));
    const called   = vals.filter(v => calledNums.includes(v));
    if (called.length === 4 && uncalled.length === 1 && available.includes(uncalled[0])) {
      return uncalled[0];
    }
  }

  // Rule 2: Block — find a number that completes 5 on player's board (4-in-a-row threat)
  for (const line of ALL_LINES) {
    const vals = line.map(i => playerBoard[i]);
    const uncalled = vals.filter(v => !calledNums.includes(v));
    const called   = vals.filter(v => calledNums.includes(v));
    if (called.length === 4 && uncalled.length === 1 && available.includes(uncalled[0])) {
      return uncalled[0];
    }
  }
  // Also block open-ended 3-in-a-row on player board
  for (const line of ALL_LINES) {
    const vals = line.map(i => playerBoard[i]);
    const uncalled = vals.filter(v => !calledNums.includes(v));
    const called   = vals.filter(v => calledNums.includes(v));
    if (called.length === 3 && uncalled.length === 2) {
      const pick = uncalled.find(v => available.includes(v));
      if (pick) return pick;
    }
  }

  // Rule 3: Random near existing called pieces
  const adjacentNums = new Set();
  calledNums.forEach(n => {
    const idx = botBrd.indexOf(n);
    if (idx === -1) return;
    const r = Math.floor(idx/5), c = idx%5;
    [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]].forEach(([dr,dc]) => {
      const nr=r+dr, nc=c+dc;
      if(nr>=0&&nr<5&&nc>=0&&nc<5) adjacentNums.add(botBrd[nr*5+nc]);
    });
  });
  const nearPicks = available.filter(n => adjacentNums.has(n));
  if (nearPicks.length > 0) return nearPicks[Math.floor(Math.random()*nearPicks.length)];

  // Fallback: random
  return aiMoveEasy(calledNums);
}

/* LEVEL 3 — Hard: Heuristic scoring matrix */
function aiMoveHard(calledNums, playerBoard, botBrd) {
  const ALL_LINES = [];
  for(let r=0;r<5;r++){const b=r*5;ALL_LINES.push([b,b+1,b+2,b+3,b+4])}
  for(let c=0;c<5;c++){ALL_LINES.push([c,c+5,c+10,c+15,c+20])}
  ALL_LINES.push([0,6,12,18,24],[4,8,12,16,20]);

  const available = Array.from({length:25},(_,i)=>i+1).filter(n=>!calledNums.includes(n));
  if (!available.length) return null;

  const scores = {};
  available.forEach(n => { scores[n] = 0; });

  // Score each available number
  available.forEach(num => {
    // Center bonus: numbers near center of player's board have higher value
    const playerIdx = playerBoard.indexOf(num);
    const botIdx    = botBrd.indexOf(num);

    // Evaluate on both boards for every line containing this number
    ALL_LINES.forEach(line => {
      // ── BOT BOARD lines ──
      if (line.includes(botIdx)) {
        const vals    = line.map(i => botBrd[i]);
        const called  = vals.filter(v => calledNums.includes(v)).length;
        const blocked = vals.some(v => playerBoard.includes(v) && !calledNums.includes(v) && v !== num);
        if (!blocked) {
          // Reward building the bot's own line
          if   (called === 4) scores[num] += 15000; // WIN
          else if(called === 3) scores[num] +=  2000;
          else if(called === 2) scores[num] +=   300;
          else if(called === 1) scores[num] +=    50;
          else                  scores[num] +=    10;
        }
      }
      // ── PLAYER BOARD lines — BLOCK threats ──
      if (line.includes(playerIdx)) {
        const vals   = line.map(i => playerBoard[i]);
        const called = vals.filter(v => calledNums.includes(v)).length;
        if   (called === 4) scores[num] += 10000; // block immediate win
        else if(called === 3) scores[num] +=  1500; // block 3-in-row
        else if(called === 2) scores[num] +=   200;
        else if(called === 1) scores[num] +=    30;
      }
    });

    // Center positional bonus on bot's board (indices 6,7,8,11,12,13,16,17,18)
    const centerIdxs = [6,7,8,11,12,13,16,17,18];
    if (centerIdxs.includes(botIdx)) scores[num] += 15;
  });

  // Pick the highest-scoring number
  return available.reduce((best, n) => scores[n] > scores[best] ? n : best, available[0]);
}

/* ── Master AI move dispatcher ── */
function getAIMove(calledNums) {
  if (botLevel === 'easy')   return aiMoveEasy(calledNums);
  if (botLevel === 'medium') return aiMoveMedium(calledNums, playerBotBoard, botBoard);
  if (botLevel === 'hard')   return aiMoveHard(calledNums, playerBotBoard, botBoard);
}

/* ═══════════════════════════════════════════════
   BOT GAME — UI & FLOW (no Firebase)
═══════════════════════════════════════════════ */

/* Highlight win cells on bot game board — staggered burst + flash */
let botLastLineCount = 0;
function botHighlightWinCells(board, selected, prefix) {
  const { winIdx, lines } = botCheckLines(board, selected);
  const isNewLine = lines > botLastLineCount;
  botLastLineCount = lines;

  // Group win indices into lines so we can stagger per-line
  const newLineSegs = [];
  if (isNewLine) {
    const ALL_LINES_BOT = [];
    for(let r=0;r<5;r++){const b=r*5;ALL_LINES_BOT.push([b,b+1,b+2,b+3,b+4]);}
    for(let c=0;c<5;c++){ALL_LINES_BOT.push([c,c+5,c+10,c+15,c+20]);}
    ALL_LINES_BOT.push([0,6,12,18,24],[4,8,12,16,20]);
    const hits = board.map(n => selected.includes(n) ? 1 : 0);
    ALL_LINES_BOT.forEach(line => {
      if (line.every(i => hits[i])) {
        const el0 = document.getElementById(`${prefix}cell-${board[line[0]]}`);
        if (el0 && !el0.classList.contains('win-line')) {
          newLineSegs.push(line);
        }
      }
    });
  }

  winIdx.forEach(idx => {
    const n = board[idx];
    const cell = document.getElementById(`${prefix}cell-${n}`);
    if (cell && !cell.classList.contains('win-line')) cell.classList.add('win-line');
  });

  if (isNewLine && newLineSegs.length > 0) {
    newLineSegs.forEach(seg => {
      const els = seg.map(i => document.getElementById(`${prefix}cell-${board[i]}`)).filter(Boolean);
      triggerLineBurst(els);
    });
    fireLineFlash();
  }
}

/* Render the player's bot-game board */
function renderBotGameBoard() {
  const boardDiv = document.getElementById('game-board');
  boardDiv.innerHTML = '';
  playerBotBoard.forEach(num => {
    const cell = document.createElement('div');
    cell.className = 'cell'; cell.textContent = num; cell.id = `cell-${num}`;
    cell.addEventListener('click', () => handleBotGameClick(num));
    boardDiv.appendChild(cell);
  });
}

/* Cross off a number visually (player board) */
function botCrossCell(num) {
  const cell = document.getElementById(`cell-${num}`);
  if (cell && !cell.classList.contains('crossed')) {
    cell.classList.add('crossed');
    sfx.cross();
  }
}

/* Show turn indicator */
function botUpdateTurnUI(isPlayerTurn) {
  document.getElementById('turn-indicator').textContent = isPlayerTurn ? 'Your Turn!' : "Bot's Turn…";
  document.getElementById('p1-box').classList.toggle('active-turn', isPlayerTurn);
  document.getElementById('p2-box').classList.toggle('active-turn', !isPlayerTurn);
  document.getElementById('ai-thinking-bar').classList.toggle('show', !isPlayerTurn);
}

/* Check and handle win condition for bot game */
function botCheckWin() {
  const playerResult = botCheckLines(playerBotBoard, botSelected);
  const botResult    = botCheckLines(botBoard, botSelected);
  if (playerResult.lines >= 5 || botResult.lines >= 5) {
    const playerWon = playerResult.lines >= botResult.lines ? playerResult.lines >= 5 : false;
    const botWon    = botResult.lines >= 5;

    botWinShown = true;
    botHighlightWinCells(playerBotBoard, botSelected, '');
    if (playerWon)  botScores.player++;
    else if (botWon) botScores.bot++;
    updateBotScoreDisplay();
    setTimeout(() => showBotWinOverlay(playerWon && !botWon), 500);
    return true;
  }
  return false;
}

/* Execute the AI's turn with a short thinking delay */
function executeBotTurn() {
  botUpdateTurnUI(false);
  const delay = botLevel === 'hard' ? 900 : botLevel === 'medium' ? 700 : 500;
  setTimeout(() => {
    if (botWinShown) return;
    const move = getAIMove(botSelected);
    if (move == null) return;
    botSelected.push(move);
    botCrossCell(move);
    if (!botCheckWin()) botUpdateTurnUI(true);
  }, delay);
}

/* Player clicks a cell in bot game */
function handleBotGameClick(num) {
  if (botWinShown) return;
  if (botSelected.includes(num)) return;
  // Only allow on player's turn (ai-thinking-bar hidden = player's turn)
  if (document.getElementById('ai-thinking-bar').classList.contains('show')) return;
  botSelected.push(num);
  botCrossCell(num);
  if (!botCheckWin()) executeBotTurn();
}

function updateBotScoreDisplay() {
  document.getElementById('score-p1').textContent = botScores.player;
  document.getElementById('score-p2').textContent = botScores.bot;
}

/* Win overlay for bot game */
function showBotWinOverlay(playerWon) {
  const winPhrases  = ['Domination! 👑','Flawless Victory! ⚡','You\'re on fire! 🔥','GG! Absolutely lethal 🎯','Champion energy! 💎'];
  const losePhrases = ['The bot outsmarted you… 🤖','GG, rematch? 💪','Respect the grind 🤝','Bot.exe wins this round 😤'];
  playerWon ? sfx.win() : sfx.lose();
  document.getElementById('win-title-text').textContent  = playerWon ? '🎉 YOU WIN!' : '🤖 BOT WINS!';
  document.getElementById('win-subtitle-text').textContent = playerWon
    ? winPhrases[Math.floor(Math.random()*winPhrases.length)]
    : losePhrases[Math.floor(Math.random()*losePhrases.length)];
  document.getElementById('win-overlay').classList.add('show');
  if (playerWon) launchConfetti();
  startBotRematchCountdown();
}

function startBotRematchCountdown() {
  const div = document.getElementById('rematch-countdown'), val = document.getElementById('countdown-val');
  let t = 10; div.style.display = 'block'; val.textContent = t;
  if (botCountdownInterval) clearInterval(botCountdownInterval);
  botCountdownInterval = setInterval(() => {
    val.textContent = --t;
    if (t <= 0) { clearInterval(botCountdownInterval); div.style.display = 'none'; restartBotGame(); }
  }, 1000);
  document.getElementById('countdown-cancel').onclick = () => { clearInterval(botCountdownInterval); div.style.display = 'none'; };
}

function restartBotGame() {
  if (botCountdownInterval) clearInterval(botCountdownInterval);
  botWinShown = false; botLastLineCount = 0;
  cleanupScheduled = false;
  document.getElementById('win-overlay').classList.remove('show');
  document.getElementById('rematch-countdown').style.display = 'none';
  document.querySelectorAll('.cell.win-line').forEach(c => c.classList.remove('win-line'));
  document.querySelectorAll('.cell.crossed').forEach(c => c.classList.remove('crossed'));
  document.getElementById('ai-thinking-bar').classList.remove('show');
  // Refresh boards and restart
  botSelected = [];
  botBoard = genRandomBoard();
  playerBotBoard = genRandomBoard();
  renderBotGameBoard();
  botUpdateTurnUI(true);
  sfx.click();
}

/* ── Listen for startBotGame event from plain script ── */
document.addEventListener('startBotGame', (e) => {
  readDINGO();
  botMode  = true;
  botLevel = e.detail.level;
  botWinShown  = false;
  botSelected  = [];
  botScores    = {player:0, bot:0};

  // Generate boards
  playerBotBoard = genRandomBoard();
  botBoard       = genRandomBoard();

  // Set up UI
  document.getElementById('p1-name').textContent   = playerName;
  document.getElementById('p1-avatar').textContent = playerAvatar;
  document.getElementById('p2-name').textContent   = BOT_NAMES[botLevel];
  document.getElementById('p2-avatar').textContent = BOT_AVATARS[botLevel];
  document.getElementById('p2-box').classList.add('is-bot');

  // Show AI mode pill
  const pill = document.getElementById('ai-mode-pill');
  pill.classList.add('show');
  pill.textContent = botLevel.toUpperCase();

  // Score labels
  document.querySelector('#score-p1 + .score-lbl').textContent = 'You';
  document.querySelector('#score-p2 + .score-lbl').textContent = 'Bot';
  updateBotScoreDisplay();

  // Render board and go to game screen
  showScreen('game');
  renderBotGameBoard();
  botUpdateTurnUI(true);

  // Hide chat FAB (bot game has no chat)
  document.getElementById('chat-fab').style.display = 'none';
  document.getElementById('chat-panel').classList.remove('open');

  sfx.click();
});

/* Patch restart/reset buttons to handle bot game */
document.getElementById('win-restart-btn').addEventListener('click', () => {
  if (botMode) restartBotGame(); else doRestart();
});
document.getElementById('restart-btn').addEventListener('click', () => {
  if (botMode) restartBotGame(); else doRestart();
});
document.getElementById('win-reset-btn').addEventListener('click', () => {
  if (botMode) { botMode=false; doReset(); } else doReset();
});
document.getElementById('reset-btn').addEventListener('click', () => {
  if (botMode) { botMode=false; doReset(); } else doReset();
});

/* Also patch home-from-game for bot mode */
document.getElementById('home-from-game').addEventListener('click', () => {
  botMode = false;
  document.getElementById('ai-mode-pill').classList.remove('show');
  document.getElementById('ai-thinking-bar').classList.remove('show');
  document.getElementById('p2-box').classList.remove('is-bot');
  leaveRoomCleanup();
  showScreen('home');
  document.getElementById('chat-fab').style.display = 'none';
  document.getElementById('chat-panel').classList.remove('open');
  document.getElementById('win-overlay').classList.remove('show');
});

/* ═══════════════════════════════════════════════
   ROOM HELPERS
═══════════════════════════════════════════════ */
function genRoomId() {
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  return Array.from({length:4},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}
function readDINGO() {
  playerName   = window.DINGO.playerName    || 'Player';
  playerAvatar = window.DINGO.selectedAvatar || '👹';
  playerColor  = window.DINGO.selectedColor  || '#00e5ff';
}

/* ═══════════════════════════════════════════════
   PRESENCE & ABANDONMENT SYSTEM
   ─ Each player writes true to rooms/{id}/presence/{role}
   ─ onDisconnect().remove() auto-clears it if tab closes
   ─ When opponent presence disappears a 60-second countdown
     starts; if they don't return the remaining player wins
   ─ When a player deliberately clicks Home we remove their
     presence ourselves so the opponent is notified instantly
═══════════════════════════════════════════════ */
let opponentWasPresent   = false;   // guard: only start countdown if opponent WAS here
let abandonInterval      = null;
let abandonSecondsLeft   = 60;
let presenceRef          = null;    // keep reference so we can remove on leave

function setupPresence() {
  if (!roomId || !playerRole) return;
  opponentWasPresent = false;
  presenceRef = ref(db, `rooms/${roomId}/presence/${playerRole}`);
  // Write true AND register auto-delete if the connection drops
  presenceRef.set(true);
  presenceRef.onDisconnect().remove();
}

function watchOpponentPresence() {
  if (!roomId || !playerRole) return;
  const opponentRole = playerRole === 'p1' ? 'p2' : 'p1';

  onValue(ref(db, `rooms/${roomId}/presence/${opponentRole}`), snap => {
    const present = snap.val();

    if (present === true) {
      opponentWasPresent = true;          // they arrived — note it
      stopAbandonCountdown(false);        // cancel any running countdown
    } else if (present === null && opponentWasPresent) {
      // They were here and are now gone
      startAbandonCountdown();
    }
  });
}

function startAbandonCountdown() {
  if (abandonInterval) return;            // already running
  // Only count down while we're in an active multiplayer screen
  if (!roomId || botMode) return;

  abandonSecondsLeft = 60;
  const banner = document.getElementById('abandon-banner');
  const timerEl = document.getElementById('abandon-timer');
  timerEl.textContent = abandonSecondsLeft;
  banner.classList.add('show');
  sfx.ping && sfx.ping();

  abandonInterval = setInterval(() => {
    abandonSecondsLeft--;
    timerEl.textContent = abandonSecondsLeft;
    if (abandonSecondsLeft <= 0) {
      stopAbandonCountdown(false);
      // Declare current player the winner
      declareAbandonWin();
    }
  }, 1000);
}

function stopAbandonCountdown(hideOnly = true) {
  if (abandonInterval) { clearInterval(abandonInterval); abandonInterval = null; }
  if (!hideOnly) return;
  document.getElementById('abandon-banner').classList.remove('show');
}

async function declareAbandonWin() {
  document.getElementById('abandon-banner').classList.remove('show');
  if (!roomId) return;
  // Write winner + a special 'abandoned' status so the win overlay
  // can show the right message
  await update(ref(db, `rooms/${roomId}/gameState`), {
    winner: playerRole,
    status: 'abandoned'
  });
}

/* ─── Graceful leave: remove own presence so opponent is notified ─── */
function leaveRoomCleanup() {
  stopAbandonCountdown(false);
  opponentWasPresent = false;
  if (presenceRef) {
    presenceRef.onDisconnect().cancel();  // cancel the auto-remove (we'll do it now)
    presenceRef.remove();
    presenceRef = null;
  }
  // If we created a room but nobody ever joined (we're p1, no p2), just delete it now
  if (roomId && playerRole === 'p1') {
    ref(db, `rooms/${roomId}/players`).get().then(snap => {
      const players = snap.val();
      if (players && !players.p2) {
        // Nobody else joined — safe to delete the whole room immediately
        set(ref(db, `rooms/${roomId}`), null).catch(() => {});
      }
    }).catch(() => {});
  }
  roomId = '';
  playerRole = '';
}

/* ═══════════════════════════════════════════════
   ROOM CLEANUP — delete Firebase data after game ends
   Fires 15 s after a winner is declared, giving both
   clients enough time to read the final game state.
   Only the player who DECLARES the win triggers the
   deletion (avoids a race condition where both try).
═══════════════════════════════════════════════ */
let cleanupScheduled = false;
function scheduleRoomCleanup() {
  if (cleanupScheduled || !roomId) return;
  cleanupScheduled = true;
  const roomToDelete = roomId;           // capture now; roomId may clear later
  setTimeout(async () => {
    try {
      await set(ref(db, `rooms/${roomToDelete}`), null);
    } catch (e) { /* already deleted or permission error — ignore */ }
  }, 15000);  // 15 seconds
}

/* ═══════════════════════════════════════════════
   STAGGERED BINGO LINE BURST + TOAST
   When a new 5-in-a-row is completed the five cells
   light up one by one (domino-style, 55 ms apart)
   and a "BINGO!" toast drops in from the top of the board.
═══════════════════════════════════════════════ */
function triggerLineBurst(cellElements) {
  // cellElements: array of DOM elements in the line, in order
  cellElements.forEach((cell, i) => {
    setTimeout(() => {
      cell.classList.add('line-burst');
      setTimeout(() => cell.classList.remove('line-burst'), 420);
    }, i * 55);
  });
  // Show the BINGO toast after the last cell lights up
  setTimeout(() => showBingoToast(), cellElements.length * 55 + 40);
}

let bingoToastTimeout = null;
function showBingoToast() {
  let toast = document.getElementById('bingo-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'bingo-toast';
    toast.style.cssText = `
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.6);
      z-index:8000;pointer-events:none;opacity:0;
      font-family:'Black Han Sans',sans-serif;font-size:clamp(38px,10vw,64px);
      letter-spacing:6px;color:var(--c3);
      text-shadow:0 0 20px rgba(255,204,0,.8),0 0 40px rgba(255,204,0,.4);
      transition:opacity .15s,transform .15s;
    `;
    toast.textContent = 'BINGO!';
    document.body.appendChild(toast);
  }
  // Force reflow then animate in
  void toast.offsetWidth;
  toast.style.opacity = '1';
  toast.style.transform = 'translate(-50%,-50%) scale(1)';
  if (bingoToastTimeout) clearTimeout(bingoToastTimeout);
  bingoToastTimeout = setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translate(-50%,-50%) scale(1.15)';
  }, 900);
}

/* ── PLAY NOW — instant matchmaking ───────────── */
document.getElementById('play-now-btn').addEventListener('click', async () => {
  readDINGO();
  if (navigator.vibrate) navigator.vibrate([40, 15, 40]);
  const btn = document.getElementById('play-now-btn');
  const msg = document.getElementById('home-msg');
  btn.disabled = true;
  btn.innerHTML = '<span class="play-now-icon">⏳</span> FINDING MATCH…';
  msg.textContent = '';
  try {
    // Look for an open room (status: waiting, only p1 present)
    const { get: _get, ref: _ref, set: _set, update: _update, onValue: _onValue } = { get, ref, set, update, onValue };
    const roomsSnap = await get(ref(db, 'rooms'));
    const rooms = roomsSnap.val() || {};
    let foundRoom = null;
    for (const [id, room] of Object.entries(rooms)) {
      if (
        room.gameState?.status === 'waiting' &&
        room.players?.p1 &&
        !room.players?.p2
      ) {
        foundRoom = id;
        break;
      }
    }
    if (foundRoom) {
      // Join existing open room
      roomId = foundRoom; playerRole = 'p2';
      await update(ref(db, `rooms/${roomId}/players`), { p2: myPlayerId });
      await update(ref(db, `rooms/${roomId}/playerInfo`), {
        p2: { name: playerName, avatar: playerAvatar, color: playerColor }
      });
      document.getElementById('display-room-code').innerText = roomId;
      document.getElementById('waiting-label').innerText = 'Connected!';
      initSetupBoard(); showScreen('setup'); showChat();
      setupPresence(); watchOpponentPresence();
      onValue(ref(db, `rooms/${roomId}/playerInfo`), snap => {
        const info = snap.val();
        if (info?.p1) { document.getElementById('p1-name').textContent = info.p1.name; document.getElementById('p1-avatar').textContent = info.p1.avatar; }
        if (info?.p2) { document.getElementById('p2-name').textContent = info.p2.name; document.getElementById('p2-avatar').textContent = info.p2.avatar; }
      });
      onValue(ref(db, `rooms/${roomId}/scores`), snap => {
        const s = snap.val();
        if (s) { scores.p1 = s.p1||0; scores.p2 = s.p2||0; updateScoreDisplay(); }
      });
    } else {
      // No open room — create one and wait
      roomId = genRoomId(); playerRole = 'p1';
      await set(ref(db, `rooms/${roomId}`), {
        players: { p1: myPlayerId },
        playerInfo: { p1: { name: playerName, avatar: playerAvatar, color: playerColor } },
        gameState: { status: 'waiting', currentTurn: 'p1', selectedNumbers: [0], winner: '' },
        scores: { p1: 0, p2: 0 }
      });
      document.getElementById('display-room-code').innerText = roomId;
      document.getElementById('waiting-label').innerText = 'Waiting for an opponent…';
      initSetupBoard(); showScreen('setup'); showChat();
      setupPresence(); watchOpponentPresence();
      onValue(ref(db, `rooms/${roomId}/playerInfo`), snap => {
        const info = snap.val();
        if (info?.p2) {
          document.getElementById('p2-name').textContent = info.p2.name;
          document.getElementById('p2-avatar').textContent = info.p2.avatar;
          document.getElementById('waiting-label').textContent = `${info.p2.name} joined!`;
        }
        if (info?.p1) {
          document.getElementById('p1-name').textContent = info.p1.name;
          document.getElementById('p1-avatar').textContent = info.p1.avatar;
        }
      });
      onValue(ref(db, `rooms/${roomId}/scores`), snap => {
        const s = snap.val();
        if (s) { scores.p1 = s.p1||0; scores.p2 = s.p2||0; updateScoreDisplay(); }
      });
      msg.textContent = '🔎 Room created — waiting for someone to join!';
      msg.style.color = 'var(--cyan)';
    }
  } catch(err) {
    let errMsg = `❌ ${err.message}`;
    if (err.message.includes('permission') || err.message.includes('PERMISSION')) {
      errMsg = '❌ Firebase rules blocking writes. Set rules to allow read/write.';
    }
    document.getElementById('home-msg').textContent = errMsg;
    setFirebaseStatus(false, errMsg);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="play-now-icon">⚡</span> PLAY NOW';
  }
});

/* ── Create Room ──────────────────────────────── */
document.getElementById('create-btn').addEventListener('click', async () => {
  readDINGO(); sfx.click();
  if (navigator.vibrate) navigator.vibrate([30, 10, 30]);
  const btn = document.getElementById('create-btn');
  const msg = document.getElementById('home-msg');
  btn.disabled = true; btn.textContent = '⏳ Creating…'; msg.textContent = '';

  try {
    roomId = genRoomId(); playerRole = 'p1';

    const roomData = {
      players:   { p1: myPlayerId },
      playerInfo:{ p1: { name: playerName, avatar: playerAvatar, color: playerColor } },
      gameState: { status: 'waiting', currentTurn: 'p1', selectedNumbers: [0], winner: '' },
      scores:    { p1: 0, p2: 0 }
    };

    await set(ref(db, `rooms/${roomId}`), roomData);

    // Confirm the write actually landed
    const check = await get(ref(db, `rooms/${roomId}/players`));
    if (!check.exists()) throw new Error('Room write did not persist — check Firebase rules');

    document.getElementById('display-room-code').innerText  = roomId;
    document.getElementById('waiting-label').innerText      = 'Waiting for opponent…';
    initSetupBoard(); showScreen('setup'); showChat();
    setupPresence(); watchOpponentPresence();

    onValue(ref(db, `rooms/${roomId}/playerInfo`), snap => {
      const info = snap.val();
      if (info?.p2) {
        document.getElementById('p2-name').textContent    = info.p2.name;
        document.getElementById('p2-avatar').textContent  = info.p2.avatar;
        document.getElementById('waiting-label').textContent = `${info.p2.name} joined!`;
      }
      if (info?.p1) {
        document.getElementById('p1-name').textContent   = info.p1.name;
        document.getElementById('p1-avatar').textContent = info.p1.avatar;
      }
    });
    onValue(ref(db, `rooms/${roomId}/scores`), snap => {
      const s = snap.val();
      if (s) { scores.p1 = s.p1 || 0; scores.p2 = s.p2 || 0; updateScoreDisplay(); }
    });

  } catch(err) {
    console.error('Create room error:', err);
    // Show a clear, helpful error message
    let errMsg = `❌ ${err.message}`;
    if (err.message.includes('permission') || err.message.includes('PERMISSION')) {
      errMsg = '❌ Firebase rules blocking writes. Set rules to allow read/write.';
      document.getElementById('firebase-rules-help').style.display = 'block';
    } else if (err.message.includes('network') || err.message.includes('fetch')) {
      errMsg = '❌ No internet connection. Check your network.';
    }
    msg.textContent = errMsg;
    msg.style.color = 'var(--pink)';
    setFirebaseStatus(false, errMsg);
  } finally {
    btn.disabled = false; btn.textContent = '＋ Create Room';
  }
});

/* ── Join Room ────────────────────────────────── */
document.getElementById('join-btn').addEventListener('click', async () => {
  readDINGO(); sfx.click();
  const btn=document.getElementById('join-btn'), msg=document.getElementById('home-msg');
  const code=document.getElementById('room-code-input').value.trim().toUpperCase();
  if(!code)return;
  btn.disabled=true; btn.textContent='⏳'; msg.textContent='';
  try {
    const snap=await get(ref(db,`rooms/${code}`));
    if(snap.exists()&&!snap.val().players.p2){
      roomId=code; playerRole='p2';
      await update(ref(db,`rooms/${code}`),{
        'players/p2':myPlayerId,
        'playerInfo/p2/name':playerName,
        'playerInfo/p2/avatar':playerAvatar,
        'playerInfo/p2/color':playerColor,
      });
      const info=snap.val().playerInfo||{};
      document.getElementById('display-room-code').innerText=roomId;
      document.getElementById('p1-name').textContent=info.p1?info.p1.name:'P1';
      document.getElementById('p1-avatar').textContent=info.p1?info.p1.avatar:'🎮';
      document.getElementById('p2-name').textContent=playerName;
      document.getElementById('p2-avatar').textContent=playerAvatar;
      document.getElementById('waiting-label').textContent='You joined!';
      initSetupBoard(); showScreen('setup'); showChat();
      setupPresence(); watchOpponentPresence();
      onValue(ref(db,`rooms/${roomId}/scores`),s=>{
        const sc=s.val();if(sc){scores.p1=sc.p1||0;scores.p2=sc.p2||0;updateScoreDisplay()}
      });
    } else {
      msg.textContent=snap.exists()?'Room is full!':'Room not found!';
      setTimeout(()=>{msg.textContent=''},3000);
    }
  } catch(err){msg.textContent=`Error: ${err.message}`;console.error(err);}
  finally{btn.disabled=false;btn.textContent='Join'}
});

/* ─── Score display ───────────────────────────── */
function updateScoreDisplay(){
  document.getElementById('score-p1').textContent=scores.p1;
  document.getElementById('score-p2').textContent=scores.p2;
}

/* ─── Setup board ─────────────────────────────── */
function initSetupBoard(){
  const bd=document.getElementById('setup-board');
  bd.innerHTML=''; myBoard=new Array(25).fill(null); setupCounter=1;
  document.getElementById('setup-progress').style.width='0%';
  document.getElementById('ready-btn').disabled=true;
  for(let i=0;i<25;i++){
    const cell=document.createElement('div');
    cell.className='cell'; cell.dataset.idx=i;
    cell.addEventListener('click',()=>placeNumber(cell,i));
    bd.appendChild(cell);
  }
}
function placeNumber(cell,idx){
  if(cell.dataset.filled||setupCounter>25)return;
  cell.textContent=setupCounter; cell.dataset.filled='true';
  myBoard[idx]=setupCounter; setupCounter++;
  sfx.click();
  document.getElementById('setup-progress').style.width=((setupCounter-1)/25*100)+'%';
  if(setupCounter>25)document.getElementById('ready-btn').disabled=false;
}
document.getElementById('shuffle-btn').addEventListener('click',()=>{
  sfx.click();
  const nums=Array.from({length:25},(_,i)=>i+1);
  for(let i=nums.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[nums[i],nums[j]]=[nums[j],nums[i]]}
  myBoard=[...nums]; setupCounter=26;
  document.querySelectorAll('#setup-board .cell').forEach((cell,i)=>{
    cell.textContent=nums[i]; cell.dataset.filled='true';
    cell.style.animation='none'; requestAnimationFrame(()=>{cell.style.animation=''});
  });
  document.getElementById('setup-progress').style.width='100%';
  document.getElementById('ready-btn').disabled=false;
});
document.getElementById('clear-btn').addEventListener('click',()=>{sfx.click();initSetupBoard()});

/* ─── Ready ───────────────────────────────────── */
document.getElementById('ready-btn').addEventListener('click',async()=>{
  sfx.click();
  const btn=document.getElementById('ready-btn');
  btn.disabled=true; btn.textContent='⏳ Waiting…';
  await update(ref(db,`rooms/${roomId}/boards`),{[playerRole]:myBoard});
  onValue(ref(db,`rooms/${roomId}/boards`),snap=>{
    const b=snap.val();
    if(b&&b.p1&&b.p2){update(ref(db,`rooms/${roomId}/gameState`),{status:'playing'});startGame()}
  });
});

/* ═══════════════════════════════════════════════
   NUMBER ANNOUNCEMENT
═══════════════════════════════════════════════ */
let announceTimer=null;
function showAnnouncement(num,callerName,isMe){
  sfx.announce();
  const bubble=document.getElementById('announce-bubble');
  bubble.classList.remove('pop','fade-out'); void bubble.offsetWidth;
  document.getElementById('announce-who').textContent=isMe?'YOU CALLED':callerName.toUpperCase();
  document.getElementById('announce-num').textContent=num;
  document.getElementById('announce-sub').textContent=isMe?'nicely done':'crosses it out';
  bubble.classList.add('pop');
  if(announceTimer)clearTimeout(announceTimer);
  announceTimer=setTimeout(()=>{bubble.classList.remove('pop');bubble.classList.add('fade-out')},1600);
}

/* ═══════════════════════════════════════════════
   START GAME
═══════════════════════════════════════════════ */
function startGame(){
  if(winShown)return; winShown=false;
  showScreen('game');
  const boardDiv=document.getElementById('game-board');
  boardDiv.innerHTML='';
  let lastLen=0;

  onValue(ref(db,`rooms/${roomId}/playerInfo`),snap=>{
    const info=snap.val()||{};
    if(info.p1){document.getElementById('p1-name').textContent=info.p1.name;document.getElementById('p1-avatar').textContent=info.p1.avatar}
    if(info.p2){document.getElementById('p2-name').textContent=info.p2.name;document.getElementById('p2-avatar').textContent=info.p2.avatar}
  });

  myBoard.forEach(num=>{
    const cell=document.createElement('div');
    cell.className='cell'; cell.textContent=num; cell.id=`cell-${num}`;
    cell.addEventListener('click',()=>handleNumberClick(num));
    boardDiv.appendChild(cell);
  });

  onValue(ref(db,`rooms/${roomId}/gameState`),snap=>{
    const state=snap.val(); if(!state)return;
    const turnText=document.getElementById('turn-indicator');
    document.getElementById('p1-box').classList.toggle('active-turn',state.currentTurn==='p1');
    document.getElementById('p2-box').classList.toggle('active-turn',state.currentTurn==='p2');

    if(state.winner&&!winShown){
      winShown=true;
      stopAbandonCountdown(false);
      const iWon=state.winner===playerRole;
      const wasAbandoned = state.status === 'abandoned';
      if(iWon){scores[playerRole]++;update(ref(db,`rooms/${roomId}/scores`),{[playerRole]:scores[playerRole]})}
      if(state.selectedNumbers)checkAndHighlightWin(state.selectedNumbers);
      setTimeout(()=>{
        showWinOverlay(iWon, wasAbandoned);
      },500);
      // The player who did NOT declare the win also schedules cleanup
      // (so cleanup fires even if the declarer disconnects right after)
      scheduleRoomCleanup();
      turnText.innerText=''; return;
    }
    turnText.innerText=state.currentTurn===playerRole?'Your Turn!':"Opponent's Turn…";

    if(state.selectedNumbers){
      if(state.selectedNumbers.length>lastLen){
        const newNum=state.selectedNumbers[state.selectedNumbers.length-1];
        if(newNum!==0){
          /* announcement popup removed — number cross animation on cell is enough */
        }
      }
      lastLen=state.selectedNumbers.length;
      state.selectedNumbers.forEach(num=>{
        if(num!==0){
          const c=document.getElementById(`cell-${num}`);
          if(c&&!c.classList.contains('crossed')){c.classList.add('crossed');sfx.cross()}
        }
      });
      checkAndHighlightWin(state.selectedNumbers);
    }
  });
}

/* ─── Handle click ────────────────────────────── */
async function handleNumberClick(num){
  const stateRef=ref(db,`rooms/${roomId}/gameState`);
  const snap=await get(stateRef); const state=snap.val();
  if(state.currentTurn===playerRole&&!state.winner&&!state.selectedNumbers.includes(num)){
    await update(stateRef,{selectedNumbers:[...state.selectedNumbers,num],currentTurn:playerRole==='p1'?'p2':'p1'});
  }
}

/* ─── Win check + highlight ───────────────────── */
/* ─── Screen flash helper ─────────────────────────── */
let flashTimeout = null;
function fireLineFlash() {
  const el = document.getElementById('line-flash');
  el.classList.remove('flash');
  void el.offsetWidth;
  el.classList.add('flash');
  if (flashTimeout) clearTimeout(flashTimeout);
  flashTimeout = setTimeout(() => el.classList.remove('flash'), 500);
}

/* ─── Win check + highlight (multiplayer) ─────────── */
let lastLineCount = 0;

// ALL_LINES definition shared with win-check helpers
const BOARD_LINES = [];
for(let r=0;r<5;r++){const b=r*5;BOARD_LINES.push([b,b+1,b+2,b+3,b+4]);}
for(let c=0;c<5;c++){BOARD_LINES.push([c,c+5,c+10,c+15,c+20]);}
BOARD_LINES.push([0,6,12,18,24],[4,8,12,16,20]);

function checkAndHighlightWin(sel){
  const hits = myBoard.map(n => sel.includes(n) ? 1 : 0);
  let lines = 0;
  const winIdx = new Set();
  // Track which new line cells to burst (per line so we can stagger in order)
  const newLineSegments = [];

  BOARD_LINES.forEach(line => {
    if (line.every(i => hits[i])) {
      // This line is complete
      const isNew = !line.some(i => {
        const c = document.getElementById(`cell-${myBoard[i]}`);
        return c && c.classList.contains('win-line');
      });
      line.forEach(i => winIdx.add(i));
      lines++;
      if (isNew) newLineSegments.push(line);
    }
  });

  const isNewLine = lines > lastLineCount;
  lastLineCount = lines;

  // Apply win-line class to all winning cells
  winIdx.forEach(idx => {
    const c = document.getElementById(`cell-${myBoard[idx]}`);
    if (c && !c.classList.contains('win-line')) c.classList.add('win-line');
  });

  // Staggered burst for every newly completed line
  if (isNewLine && newLineSegments.length > 0) {
    newLineSegments.forEach(seg => {
      const els = seg.map(i => document.getElementById(`cell-${myBoard[i]}`)).filter(Boolean);
      triggerLineBurst(els);
    });
    fireLineFlash();
    sfx.cross && sfx.cross();
  }

  if (lines >= 5) {
    update(ref(db, `rooms/${roomId}/gameState`), {winner: playerRole});
    scheduleRoomCleanup(); // ← delete Firebase data 15 s after win is declared
  }
}

/* ═══════════════════════════════════════════════
   WIN OVERLAY
═══════════════════════════════════════════════ */
const winPhrases =['Domination! 👑','Flawless Victory! ⚡','You\'re on fire! 🔥','GG! Absolutely lethal 🎯','Champion energy! 💎'];
const losePhrases=['So close… Try again 💪','Next time you\'ll have it!','Respect the grind 🤝'];
function showWinOverlay(iWon, wasAbandoned){
  iWon?sfx.win():sfx.lose();
  if (wasAbandoned && iWon) {
    document.getElementById('win-title-text').textContent = '🏆 YOU WIN!';
    document.getElementById('win-subtitle-text').textContent = '🏃 Opponent fled the arena!';
  } else if (wasAbandoned && !iWon) {
    document.getElementById('win-title-text').textContent = '😔 YOU LEFT';
    document.getElementById('win-subtitle-text').textContent = 'Opponent claimed the victory.';
  } else {
    document.getElementById('win-title-text').textContent=iWon?'🎉 YOU WIN!':'😢 YOU LOSE';
    document.getElementById('win-subtitle-text').textContent=iWon
      ?winPhrases[Math.floor(Math.random()*winPhrases.length)]
      :losePhrases[Math.floor(Math.random()*losePhrases.length)];
  }
  document.getElementById('win-overlay').classList.add('show');
  if(iWon)launchConfetti();
  startRematchCountdown(); updateScoreDisplay();
}

/* ─── Rematch countdown ───────────────────────── */
function startRematchCountdown(){
  const div=document.getElementById('rematch-countdown'),val=document.getElementById('countdown-val');
  let t=10; div.style.display='block'; val.textContent=t;
  if(countdownInterval)clearInterval(countdownInterval);
  countdownInterval=setInterval(()=>{val.textContent=--t;if(t<=0){clearInterval(countdownInterval);div.style.display='none';doRestart()}},1000);
  document.getElementById('countdown-cancel').onclick=()=>{clearInterval(countdownInterval);div.style.display='none'};
}

/* ─── Confetti ────────────────────────────────── */
function launchConfetti(){
  const canvas=document.getElementById('confetti-canvas'),ctx=canvas.getContext('2d');
  canvas.width=window.innerWidth; canvas.height=window.innerHeight;
  const cols=['#00e5ff','#ff3cac','#ffd166','#06ffa5','#ffffff','#ff6b6b'];
  const pieces=Array.from({length:200},()=>({
    x:Math.random()*canvas.width,y:Math.random()*canvas.height-canvas.height,
    w:6+Math.random()*8,h:10+Math.random()*14,
    c:cols[Math.floor(Math.random()*cols.length)],
    r:Math.random()*Math.PI*2,rd:(Math.random()-.5)*.2,
    vy:3+Math.random()*5,vx:(Math.random()-.5)*3
  }));
  let frame;
  (function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p=>{
      p.y+=p.vy;p.x+=p.vx;p.r+=p.rd;p.vy+=.08;
      if(p.y>canvas.height){p.y=-20;p.x=Math.random()*canvas.width}
      ctx.save();ctx.translate(p.x+p.w/2,p.y+p.h/2);ctx.rotate(p.r);
      ctx.fillStyle=p.c;ctx.globalAlpha=.85;ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);ctx.restore();
    });
    frame=requestAnimationFrame(draw);
  })();
  setTimeout(()=>{cancelAnimationFrame(frame);ctx.clearRect(0,0,canvas.width,canvas.height)},5000);
}

/* ─── Restart / reset ─────────────────────────── */
async function doRestart(){
  if(countdownInterval)clearInterval(countdownInterval);
  winShown=false; lastLineCount=0; cleanupScheduled=false;
  stopAbandonCountdown(false);
  document.getElementById('win-overlay').classList.remove('show');
  document.getElementById('rematch-countdown').style.display='none';
  document.querySelectorAll('.cell.win-line').forEach(c=>c.classList.remove('win-line'));
  await update(ref(db,`rooms/${roomId}/gameState`),{status:'waiting',currentTurn:'p1',selectedNumbers:[0],winner:''});
  await set(ref(db,`rooms/${roomId}/boards`),null);
  initSetupBoard(); showScreen('setup');
  const rb=document.getElementById('ready-btn');rb.disabled=true;rb.textContent="✓ I'm Ready!";
  sfx.click();
}
function doReset(){
  if(countdownInterval)clearInterval(countdownInterval);
  // Clean up Firebase presence & room before leaving
  leaveRoomCleanup();
  // Go home — never back to the splash/welcome screen
  showScreen('home');
  document.getElementById('chat-fab').style.display='none';
  document.getElementById('chat-panel').classList.remove('open');
  document.getElementById('win-overlay').classList.remove('show');
}

/* original restart/reset handled above with bot-mode awareness */
/* ── Keeping doRestart / doReset for multiplayer mode ── */

/* ═══════════════════════════════════════════════
   CHAT SYSTEM
   — emoji + text
   — last message shown in BOTH players' profile boxes
═══════════════════════════════════════════════ */
const CHAT_EMOJIS=['👍','🔥','😂','😱','🎯','💀','🏆','😤','🤯','👏','😈','🫡'];

/* Track last seen message ts to avoid re-processing */
let lastChatTs = 0;

/* Update the little status line under a player's name —
   works on BOTH screens since both players share the same DOM structure */
function updatePlayerStatus(senderRole, text) {
  // Update on THIS player's screen under the correct player box
  const el = document.getElementById(senderRole + '-status');
  if (!el) return;
  el.textContent = text.length > 22 ? text.slice(0,21)+'…' : text;
  el.classList.remove('visible');
  // Force reflow so the animation re-triggers
  void el.offsetWidth;
  el.classList.add('visible');
  clearTimeout(el._fadeTimer);
  el._fadeTimer = setTimeout(() => el.classList.remove('visible'), 7000);
}

function showChat(){
  document.getElementById('chat-fab').style.display='flex';
  const emojiBar=document.getElementById('chat-emojis');
  emojiBar.innerHTML='';
  CHAT_EMOJIS.forEach(em=>{
    const btn=document.createElement('button');
    btn.className='emoji-btn'; btn.textContent=em;
    btn.addEventListener('click',()=>{
      sendMessage(em,true);
      chatOpen=false;
      document.getElementById('chat-panel').classList.remove('open');
    });
    emojiBar.appendChild(btn);
  });

  onValue(ref(db,`rooms/${roomId}/chat`),snap=>{
    const msgs=snap.val(); if(!msgs)return;
    const container=document.getElementById('chat-messages');
    container.innerHTML='';
    const list=Object.values(msgs).slice(-40);

    list.forEach(m=>{
      const wrap=document.createElement('div');
      wrap.className='chat-msg'+(m.sender===playerRole?' mine':'');
      const bubble=document.createElement('div');
      bubble.className='chat-bubble'+(m.isEmoji?' emoji-only':'');
      bubble.textContent=m.text;
      const sender=document.createElement('div');
      sender.className='chat-sender'; sender.textContent=m.senderName;
      wrap.appendChild(bubble); wrap.appendChild(sender);
      container.appendChild(wrap);
    });
    container.scrollTop=container.scrollHeight;

    // ── Always update BOTH players' status boxes from the latest message ──
    // This fires on BOTH clients via Firebase realtime, so both screens update
    if(list.length>0){
      const last=list[list.length-1];
      // Only process if this is a genuinely new message
      if((last.ts||0) > lastChatTs){
        lastChatTs = last.ts||Date.now();
        // Update the sender's status box on this screen (works for both players)
        updatePlayerStatus(last.sender, last.text);
        // Show badge + ping only for the receiver (not the sender)
        if(last.sender !== playerRole){
          if(!chatOpen){
            document.getElementById('chat-badge').classList.add('show');
            sfx.ping();
          }
        }
      }
    }
  });
}

async function sendMessage(text,isEmoji=false){
  if(!text.trim())return;
  await push(ref(db,`rooms/${roomId}/chat`),{text,isEmoji,sender:playerRole,senderName:playerName,ts:Date.now()});
}

document.getElementById('chat-send-btn').addEventListener('click',()=>{
  const input=document.getElementById('chat-text-input');
  const txt=input.value.trim();
  if(txt){sendMessage(txt,false);input.value='';chatOpen=false;document.getElementById('chat-panel').classList.remove('open')}
});
document.getElementById('chat-text-input').addEventListener('keydown',e=>{
  if(e.key==='Enter')document.getElementById('chat-send-btn').click();
});
document.getElementById('chat-fab').addEventListener('click',()=>{
  chatOpen=!chatOpen;
  document.getElementById('chat-panel').classList.toggle('open',chatOpen);
  if(chatOpen){document.getElementById('chat-badge').classList.remove('show');document.getElementById('chat-messages').scrollTop=9999}
});
</script>

<!-- ═══════════════════════════════════════════════
     PWA — Manifest · Service Worker · Install Prompt
     Single-file approach: generate manifest + SW as Blob URLs
═══════════════════════════════════════════════ -->
<script>
(function initPWA() {
  /* ── 1. SVG App Icon → PNG data URL for the manifest ──────── */
  const ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <rect width="512" height="512" rx="100" fill="#0d0d0f"/>
    <rect width="512" height="512" rx="100" fill="url(#bg)"/>
    <defs>
      <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#0d0d0f"/>
        <stop offset="100%" stop-color="#1c1c1f"/>
      </linearGradient>
    </defs>
    <!-- 5×5 grid dots (dim) -->
    <g fill="#00ffcc" opacity="0.12">
      ${Array.from({length:5},(_,r)=>Array.from({length:5},(_,c)=>
        `<rect x="${68+c*94}" y="${68+r*94}" width="44" height="44" rx="10"/>`
      ).join('')).join('')}
    </g>
    <!-- Diagonal win line highlight (gold glow) -->
    <g fill="#ffcc00">
      <rect x="64" y="64" width="56" height="56" rx="12"/>
      <rect x="158" y="158" width="56" height="56" rx="12"/>
      <rect x="252" y="252" width="56" height="56" rx="12"/>
      <rect x="346" y="346" width="56" height="56" rx="12"/>
      <rect x="440" y="440" width="56" height="56" rx="12" opacity="0.9"/>
    </g>
    <!-- DiNGo wordmark -->
    <text x="256" y="210" text-anchor="middle" font-family="Arial Black,Impact,sans-serif"
      font-size="148" font-weight="900" letter-spacing="-4" fill="#00ffcc">Di</text>
    <text x="256" y="370" text-anchor="middle" font-family="Arial Black,Impact,sans-serif"
      font-size="148" font-weight="900" letter-spacing="-4" fill="#ff2d55">Go</text>
    <!-- Lightning bolt centre accent -->
    <text x="256" y="295" text-anchor="middle" font-family="Arial,sans-serif" font-size="72" fill="#ffcc00">⚡</text>
    <!-- Neon top bar -->
    <rect x="0" y="0" width="512" height="8" rx="4" fill="url(#bar)"/>
    <defs>
      <linearGradient id="bar" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#00ffcc"/>
        <stop offset="50%" stop-color="#ff2d55"/>
        <stop offset="100%" stop-color="#ffcc00"/>
      </linearGradient>
    </defs>
  </svg>`;

  /* Convert SVG to a data URL for use in manifest icons */
  const iconDataURL = 'data:image/svg+xml;base64,' + btoa(ICON_SVG);

  /* Patch the apple-touch-icon link */
  document.getElementById('apple-icon').href = iconDataURL;

  /* ── 2. Create the Web App Manifest as a Blob ─────────────── */
  const manifest = {
    name: 'DiNGo — Live Multiplayer Bingo',
    short_name: 'DiNGo',
    description: '5-in-a-row live multiplayer bingo. Challenge friends or battle the AI.',
    start_url: './',
    display: 'standalone',
    background_color: '#0d0d0f',
    theme_color: '#00ffcc',
    orientation: 'portrait',
    icons: [
      { src: iconDataURL, sizes: '192x192', type: 'image/svg+xml', purpose: 'any maskable' },
      { src: iconDataURL, sizes: '512x512', type: 'image/svg+xml', purpose: 'any maskable' },
    ]
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
  const manifestURL  = URL.createObjectURL(manifestBlob);
  document.getElementById('pwa-manifest').href = manifestURL;

  /* ── 3. Register a minimal Service Worker via Blob ────────── */
  const SW_CODE = `
const CACHE = 'dingo-v1';
self.addEventListener('install', e => {
  self.skipWaiting();
  e.waitUntil(
    caches.open(CACHE).then(c => c.addAll(['./', location.href]))
  );
});
self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(keys =>
    Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
  ));
  self.clients.claim();
});
self.addEventListener('fetch', e => {
  e.respondWith(
    caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match('./')))
  );
});`;

  if ('serviceWorker' in navigator) {
    const swBlob = new Blob([SW_CODE], { type: 'application/javascript' });
    const swURL  = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL).catch(() => {/* blob SW may not work in all browsers */});
  }

  /* ── 4. Install prompt banner logic ───────────────────────── */
  const banner  = document.getElementById('pwa-install-banner');
  const installBtn = document.getElementById('pwa-install-btn');
  const dismissBtn = document.getElementById('pwa-dismiss-btn');
  let deferredPrompt = null;

  /* Don't show again if user dismissed within 7 days */
  const lastDismiss = parseInt(localStorage.getItem('pwa_dismiss') || '0', 10);
  const dismissed   = (Date.now() - lastDismiss) < 7 * 24 * 3600 * 1000;

  /* Also hide if already installed (display-mode: standalone) */
  const alreadyInstalled = window.matchMedia('(display-mode: standalone)').matches
                        || window.navigator.standalone === true;

  if (!dismissed && !alreadyInstalled) {
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      /* Delay banner so it doesn't clash with the splash screen */
      setTimeout(() => banner.classList.add('show'), 3500);
    });
  }

  installBtn.addEventListener('click', async () => {
    banner.classList.remove('show');
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      if (outcome === 'accepted') {
        console.log('[PWA] User installed DiNGo ✅');
      }
    } else {
      /* Fallback: iOS / browsers that don't expose beforeinstallprompt */
      alert('To install: tap the Share button → "Add to Home Screen" 📲');
    }
  });

  dismissBtn.addEventListener('click', () => {
    banner.classList.remove('show');
    localStorage.setItem('pwa_dismiss', String(Date.now()));
  });

  /* Also hide banner when the game starts (so it doesn't block gameplay) */
  const _origShow = window.showScreen;
  window.showScreen = function(name) {
    if (_origShow) _origShow(name);
    if (name !== 'splash' && name !== 'name') banner.classList.remove('show');
  };

})();
</script>
</body>
</html>
