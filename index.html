<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DiNGo</title>

<style>
body{
margin:0;
font-family:Arial;
background:#0f1220;
color:white;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
}
.card{
width:95%;
max-width:420px;
background:#161a2f;
padding:18px;
border-radius:16px;
}
button{
width:100%;
padding:12px;
margin-top:10px;
border:none;
border-radius:10px;
background:#7c5cff;
color:white;
font-weight:bold;
cursor:pointer;
}
.board{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:6px;
margin-top:12px;
}
.cell{
background:#1f2545;
padding:14px;
text-align:center;
border-radius:8px;
cursor:pointer;
}
.cell.marked{
background:#00e5ff;
color:black;
}
.winner-overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,0.8);
display:flex;
justify-content:center;
align-items:center;
flex-direction:column;
font-size:28px;
z-index:999;
animation:fadeIn .3s ease;
}
@keyframes fadeIn{
from{opacity:0}
to{opacity:1}
}
</style>
</head>
<body>

<div id="app"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update, remove, onDisconnect, get } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAhhGzyMUJrfzYsOw4Uy-qu6F_IOqrh3PA",
  authDomain: "dingo-v2-0.firebaseapp.com",
  databaseURL: "https://dingo-v2-0-default-rtdb.firebaseio.com",
  projectId: "dingo-v2-0",
  storageBucket: "dingo-v2-0.firebasestorage.app",
  messagingSenderId: "908358383631",
  appId: "1:908358383631:web:09473d12f079a230134b7a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let user, roomId, myBoard, myMarks, myScore;
const appDiv = document.getElementById("app");

/* ================= INIT ================= */

async function init(){
  const res = await signInAnonymously(auth);
  user = { uid:res.user.uid, name:"Guest_"+Math.floor(Math.random()*9999) };
  renderHome();
}
init();

/* ================= HOME ================= */

function renderHome(){
  appDiv.innerHTML=`
  <div class="card">
    <h2>DiNGo</h2>
    <p>${user.name}</p>
    <button onclick="createPrivate()">Private Room</button>
    <button onclick="findPublic()">Public Match</button>
  </div>`;
}

/* ================= BOARD ================= */

function generateBoard(){
  return Array.from({length:25},(_,i)=>i+1)
  .sort(()=>Math.random()-0.5);
}

/* ================= PRIVATE ================= */

window.createPrivate = async ()=>{
  const roomRef = push(ref(db,"rooms"));
  roomId=roomRef.key;

  await set(roomRef,{
    turn:user.uid,
    players:{
      [user.uid]:{name:user.name,score:0}
    },
    called:[],
    status:"playing"
  });

  joinRoom();
};

/* ================= PUBLIC ================= */

window.findPublic = async ()=>{
  const queueRef = ref(db,"queue");
  await push(queueRef,{uid:user.uid,name:user.name});

  onValue(queueRef,async snap=>{
    const players=snap.val();
    if(players && Object.keys(players).length>=2){
      const ids=Object.keys(players);
      const roomRef=push(ref(db,"rooms"));
      roomId=roomRef.key;

      const p1=players[ids[0]];
      const p2=players[ids[1]];

      await set(roomRef,{
        turn:p1.uid,
        players:{
          [p1.uid]:{name:p1.name,score:0},
          [p2.uid]:{name:p2.name,score:0}
        },
        called:[],
        status:"playing"
      });

      remove(queueRef);
      joinRoom();
    }
  });
};

/* ================= JOIN ================= */

function joinRoom(){
  myBoard=generateBoard();
  myMarks=[];
  myScore=0;

  const playerRef=ref(db,`rooms/${roomId}/players/${user.uid}`);
  onDisconnect(playerRef).remove();

  renderRoom();
  monitorRoomCleanup();
}

/* ================= ROOM ================= */

function renderRoom(){
  appDiv.innerHTML=`
  <div class="card">
    <h3>Room: ${roomId}</h3>
    <div id="turn"></div>
    <div id="board" class="board"></div>
    <button onclick="exitRoom()">Exit</button>
  </div>`;

  const roomRef=ref(db,`rooms/${roomId}`);
  onValue(roomRef,snap=>{
    const data=snap.val();
    if(!data) return;

    if(data.status==="finished"){
      showWinner(data.winner);
      return;
    }

    document.getElementById("turn").innerHTML=
      data.turn===user.uid?"Your Turn":"Opponent Turn";

    updateBoard(data.called);
  });
}

/* ================= MOVE ================= */

async function makeMove(index){
  const roomRef=ref(db,`rooms/${roomId}`);
  const snap=await get(roomRef);
  const data=snap.val();
  if(data.turn!==user.uid) return;

  const number=myBoard[index];
  if(data.called.includes(number)) return;

  const newCalled=[...data.called,number];
  const nextTurn=Object.keys(data.players)
  .find(id=>id!==user.uid);

  await update(roomRef,{
    called:newCalled,
    turn:nextTurn
  });
}

/* ================= BOARD UPDATE ================= */

function updateBoard(called){
  const boardDiv=document.getElementById("board");
  boardDiv.innerHTML="";
  myBoard.forEach((num,index)=>{
    const marked=called.includes(num);
    if(marked && !myMarks.includes(index)){
      myMarks.push(index);
    }
    const cell=document.createElement("div");
    cell.className="cell"+(marked?" marked":"");
    cell.innerText=num;
    cell.onclick=()=>makeMove(index);
    boardDiv.appendChild(cell);
  });
  calculateScore();
}

/* ================= SCORE + WIN ================= */

function calculateScore(){
  const wins=[[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
  [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
  [0,6,12,18,24],[4,8,12,16,20]];

  let count=0;
  wins.forEach(combo=>{
    if(combo.every(i=>myMarks.includes(i))) count++;
  });

  if(count>=5){
    update(ref(db,`rooms/${roomId}`),{
      status:"finished",
      winner:user.uid
    });
  }
}

/* ================= WINNER UI ================= */

function showWinner(winnerId){
  const overlay=document.createElement("div");
  overlay.className="winner-overlay";
  overlay.innerHTML=`
    <div>${winnerId===user.uid?"YOU WIN!":"YOU LOSE!"}</div>
    <button onclick="requestRematch()">Rematch</button>
    <button onclick="exitRoom()">Leave</button>
  `;
  document.body.appendChild(overlay);
}

/* ================= REMATCH ================= */

async function requestRematch(){
  await update(ref(db,`rooms/${roomId}/players/${user.uid}`),{
    rematch:true
  });

  const snap=await get(ref(db,`rooms/${roomId}`));
  const players=snap.val().players;

  const allReady=Object.values(players).length===2 &&
  Object.values(players).every(p=>p.rematch);

  if(allReady){
    await update(ref(db,`rooms/${roomId}`),{
      status:"playing",
      called:[],
      winner:null
    });

    Object.keys(players).forEach(uid=>{
      update(ref(db,`rooms/${roomId}/players/${uid}`),{
        rematch:false,
        score:0
      });
    });

    document.querySelector(".winner-overlay").remove();
    joinRoom();
  }
}

/* ================= AUTO CLEANUP ================= */

function monitorRoomCleanup(){
  const playersRef = ref(db,`rooms/${roomId}/players`);
  let timer=null;

  onValue(playersRef,snap=>{
    const players=snap.val();
    const count=players?Object.keys(players).length:0;

    if(count===0){
      remove(ref(db,`rooms/${roomId}`));
    }

    if(count===1){
      if(!timer){
        timer=setTimeout(async()=>{
          const latest=await get(playersRef);
          if(!latest.exists()||Object.keys(latest.val()).length<=1){
            await remove(ref(db,`rooms/${roomId}`));
          }
        },60000);
      }
    }
  });
}

/* ================= EXIT ================= */

window.exitRoom=()=>{
  remove(ref(db,`rooms/${roomId}/players/${user.uid}`));
  location.reload();
};

</script>
</body>
</html>
