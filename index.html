<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>DiNGo â€“ Real-Time Multiplayer Bingo</title>
  <meta name="description" content="Real-time multiplayer bingo â€“ challenge a friend or match instantly!" />
  <meta name="theme-color" content="#080a14" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DiNGo" />

  <!-- Inline manifest link (Blob URL injected by JS) -->
  <link id="pwa-manifest" rel="manifest" />

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FONTS  â€“ Orbitron (numbers/logo) + Exo 2 (UI text)
       Both have generous fallbacks so the app still looks good
       without network access after first load.
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Exo+2:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION A â€“ DESIGN TOKENS & RESET
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      /* Core palette */
      --bg:          #080a14;
      --bg2:         #0d1020;
      --surface:     #111527;
      --surface2:    #181c35;
      --border:      #1f2545;
      --border-glow: #2a3060;

      /* Accent colors */
      --coral:       #ff3d5a;
      --coral-dim:   rgba(255,61,90,0.15);
      --coral-glow:  rgba(255,61,90,0.35);
      --teal:        #00d4aa;
      --teal-dim:    rgba(0,212,170,0.12);
      --teal-glow:   rgba(0,212,170,0.3);
      --gold:        #ffb930;
      --purple:      #7c4dff;

      /* Text */
      --text:        #dde2f0;
      --text-muted:  #5a627a;
      --text-dim:    #3a4060;

      /* Cell states */
      --cell-bg:     #12162a;
      --cell-marked: rgba(255,61,90,0.22);
      --cell-line:   rgba(255,61,90,0.45);
      --cell-free:   rgba(0,212,170,0.18);

      --radius-sm:   8px;
      --radius:      14px;
      --radius-lg:   22px;
      --transition:  0.18s cubic-bezier(0.4,0,0.2,1);

      /* Typography */
      --font-ui:     'Exo 2', 'Segoe UI', system-ui, sans-serif;
      --font-num:    'Orbitron', 'Courier New', monospace;
    }

    html {
      height: 100%;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      height: 100%;
      min-height: 100dvh;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      overflow-x: hidden;
      /* Subtle grid texture */
      background-image:
        linear-gradient(rgba(255,255,255,0.014) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.014) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION B â€“ SCREEN SYSTEM
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100dvh;
      padding: 24px 20px;
      animation: screenIn 0.28s ease both;
    }
    .screen.active { display: flex; }

    @keyframes screenIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Game screen overrides (scrollable, top-aligned) */
    #screen-game {
      justify-content: flex-start;
      padding: 10px;
      overflow-y: auto;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION C â€“ LOGO & BRANDING
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .logo {
      font-family: var(--font-num);
      font-size: clamp(2.6rem, 10vw, 4rem);
      font-weight: 900;
      letter-spacing: 0.05em;
      color: var(--coral);
      text-shadow:
        0 0 20px var(--coral-glow),
        0 0 60px rgba(255,61,90,0.15);
      margin-bottom: 4px;
      line-height: 1;
    }
    .logo .accent { color: var(--text); }
    .logo-small {
      font-size: clamp(1.4rem, 5vw, 1.8rem);
      margin-bottom: 2px;
    }

    .tagline {
      font-size: 0.78rem;
      color: var(--text-muted);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 40px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION D â€“ BUTTONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      max-width: 300px;
      padding: 15px 24px;
      border: none;
      border-radius: var(--radius);
      font-family: var(--font-ui);
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: all var(--transition);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .btn:active { transform: scale(0.96); }
    .btn:disabled {
      opacity: 0.38;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Primary â€“ coral */
    .btn-primary {
      background: var(--coral);
      color: #fff;
      box-shadow: 0 4px 24px var(--coral-glow), 0 1px 0 rgba(255,255,255,0.15) inset;
      margin-bottom: 12px;
    }
    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 6px 32px rgba(255,61,90,0.55), 0 1px 0 rgba(255,255,255,0.15) inset;
      transform: translateY(-1px);
    }

    /* Secondary â€“ ghost */
    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .btn-secondary:hover:not(:disabled) {
      background: var(--border-glow);
      border-color: var(--border-glow);
    }

    /* Success â€“ teal */
    .btn-success {
      background: var(--teal);
      color: #000;
      box-shadow: 0 4px 24px var(--teal-glow);
      margin-bottom: 12px;
    }
    .btn-success:hover:not(:disabled) {
      box-shadow: 0 6px 32px rgba(0,212,170,0.5);
      transform: translateY(-1px);
    }

    /* Ghost text link */
    .btn-ghost {
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: var(--font-ui);
      font-size: 0.85rem;
      cursor: pointer;
      padding: 8px 12px;
      transition: color var(--transition);
    }
    .btn-ghost:hover { color: var(--text); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION E â€“ CARDS & INPUTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 20px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 16px;
      text-align: center;
    }
    .card-label {
      font-size: 0.68rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 6px;
    }
    .card-value {
      font-family: var(--font-num);
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--coral);
      letter-spacing: 0.06em;
    }

    .field-group { width: 100%; max-width: 300px; margin-bottom: 14px; }
    .field-label {
      display: block;
      font-size: 0.68rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 7px;
    }

    input[type="text"] {
      width: 100%;
      padding: 13px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 1rem;
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    input[type="text"]:focus {
      border-color: var(--coral);
      box-shadow: 0 0 0 3px var(--coral-dim);
    }
    input[type="text"]::placeholder { color: var(--text-dim); }

    /* Room code input â€“ styled differently */
    .code-input {
      text-align: center;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-family: var(--font-num);
      font-size: 1.3rem;
    }

    /* Divider */
    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      max-width: 300px;
      margin: 4px 0 16px;
      color: var(--text-dim);
      font-size: 0.75rem;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* Copy row */
    .copy-row {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 14px;
    }
    .copy-row input { flex: 1; font-size: 0.78rem; padding: 10px 12px; }
    .copy-btn {
      padding: 10px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.78rem;
      font-family: var(--font-ui);
      font-weight: 600;
      white-space: nowrap;
      transition: all var(--transition);
    }
    .copy-btn:hover { background: var(--border-glow); color: var(--text); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION F â€“ LOADING / SPINNER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .spinner {
      width: 44px;
      height: 44px;
      border: 3px solid var(--border);
      border-top-color: var(--coral);
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      margin: 24px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .dots::after {
      content: '';
      animation: dotcycle 1.5s steps(4, end) infinite;
    }
    @keyframes dotcycle {
      0%  { content: '';    }
      25% { content: '.';   }
      50% { content: '..';  }
      75% { content: '...'; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION G â€“ GAME SCREEN LAYOUT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* Top header bar */
    .game-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 480px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 14px;
      margin-bottom: 8px;
    }

    .pinfo { flex: 1; }
    .pinfo.right { text-align: right; }

    .pname {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: 0.08em;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 110px;
    }
    .pinfo.right .pname { margin-left: auto; }

    .pscore {
      font-family: var(--font-num);
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--coral);
      line-height: 1;
    }

    .pips {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }
    .pinfo.right .pips { justify-content: flex-end; }
    .pip {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: background var(--transition), box-shadow var(--transition);
    }
    .pip.on {
      background: var(--coral);
      box-shadow: 0 0 6px var(--coral-glow);
    }

    .vs-badge {
      font-family: var(--font-num);
      font-size: 0.7rem;
      color: var(--text-dim);
      font-weight: 700;
      padding: 0 12px;
      flex-shrink: 0;
    }

    /* Turn banner */
    .turn-banner {
      width: 100%;
      max-width: 480px;
      text-align: center;
      padding: 9px 16px;
      border-radius: var(--radius-sm);
      font-size: 0.82rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
      border: 1px solid transparent;
      transition: all var(--transition);
    }
    .turn-banner.mine {
      background: var(--coral-dim);
      border-color: rgba(255,61,90,0.3);
      color: var(--coral);
    }
    .turn-banner.theirs {
      background: rgba(255,255,255,0.03);
      border-color: var(--border);
      color: var(--text-muted);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION H â€“ BINGO BOARD
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .board-wrap {
      width: 100%;
      max-width: 480px;
    }

    /* BINGO letter header */
    .bingo-letters {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 3px;
      margin-bottom: 3px;
    }
    .bletter {
      text-align: center;
      font-family: var(--font-num);
      font-size: clamp(0.85rem, 4vw, 1.1rem);
      font-weight: 900;
      color: var(--coral);
      padding: 4px 0;
      text-shadow: 0 0 12px var(--coral-glow);
    }

    /* 5Ã—5 grid */
    .bingo-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 3px;
    }

    .cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--cell-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: var(--font-num);
      font-size: clamp(0.65rem, 3.2vw, 0.95rem);
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      position: relative;
      transition: all var(--transition);
      color: var(--text);
    }
    .cell:active { transform: scale(0.91); }

    /* Free center cell */
    .cell.free {
      background: var(--cell-free);
      border-color: rgba(0,212,170,0.3);
      color: var(--teal);
      font-size: clamp(0.5rem, 2.2vw, 0.65rem);
      cursor: default;
      box-shadow: 0 0 10px rgba(0,212,170,0.1) inset;
    }

    /* Called / marked by either player */
    .cell.marked {
      background: var(--cell-marked);
      border-color: rgba(255,61,90,0.4);
      color: var(--coral);
    }

    /* Part of a completed bingo line */
    .cell.line-win {
      background: var(--cell-line);
      border-color: var(--coral);
      color: #fff;
      box-shadow:
        0 0 12px var(--coral-glow) inset,
        0 0 8px var(--coral-glow);
    }

    /* Clickable hint on player's turn */
    .cell.clickable:not(.marked):not(.free):hover {
      border-color: rgba(255,61,90,0.6);
      background: rgba(255,61,90,0.08);
      transform: scale(1.04);
    }

    /* Dimmed when not your turn */
    .cell.dimmed:not(.marked):not(.free) {
      opacity: 0.55;
      cursor: not-allowed;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION I â€“ CALLED NUMBERS LIST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .called-wrap {
      width: 100%;
      max-width: 480px;
      margin-top: 10px;
    }
    .called-title {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 7px;
    }
    .called-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .chip {
      font-family: var(--font-num);
      font-size: 0.7rem;
      font-weight: 700;
      padding: 3px 9px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--gold);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION J â€“ RESULT OVERLAY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(4,6,16,0.9);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .overlay.show { display: flex; }

    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 44px 32px 36px;
      text-align: center;
      width: 100%;
      max-width: 320px;
      animation: popIn 0.32s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }
    @keyframes popIn {
      from { transform: scale(0.75); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }

    .result-icon { font-size: 3.6rem; margin-bottom: 10px; line-height: 1; }
    .result-headline {
      font-family: var(--font-num);
      font-size: 2.1rem;
      font-weight: 900;
      margin-bottom: 6px;
      letter-spacing: 0.05em;
    }
    .result-headline.win  { color: var(--teal);  text-shadow: 0 0 20px var(--teal-glow);  }
    .result-headline.lose { color: var(--coral); text-shadow: 0 0 20px var(--coral-glow); }

    .result-sub {
      color: var(--text-muted);
      font-size: 0.88rem;
      margin-bottom: 32px;
    }

    /* Waiting for opponent rematch */
    .rematch-waiting {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION K â€“ TOAST NOTIFICATION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #toast {
      position: fixed;
      bottom: max(24px, env(safe-area-inset-bottom, 24px));
      left: 50%;
      transform: translateX(-50%) translateY(calc(100% + 24px));
      background: var(--surface2);
      border: 1px solid var(--border-glow);
      border-radius: 40px;
      padding: 10px 22px;
      font-size: 0.84rem;
      font-weight: 600;
      color: var(--text);
      z-index: 999;
      transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
      white-space: nowrap;
      pointer-events: none;
    }
    #toast.visible {
      transform: translateX(-50%) translateY(0);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION L â€“ MISCELLANEOUS HELPERS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .mt8  { margin-top: 8px;  }
    .mt16 { margin-top: 16px; }
    .fade-pulse { animation: fpulse 1.6s ease-in-out infinite; }
    @keyframes fpulse { 0%,100%{opacity:1} 50%{opacity:0.35} }

    /* Responsive cap for very wide screens */
    @media (min-width: 520px) {
      .screen { padding: 32px 24px; }
      #screen-game { padding: 14px; }
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€“ LOADING (shown immediately while Firebase connects)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen active" id="screen-loading">
  <div class="logo">Di<span class="accent">N</span>Go</div>
  <div class="spinner"></div>
  <p style="color:var(--text-muted);font-size:0.82rem;">
    Connecting<span class="dots"></span>
  </p>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€“ MAIN MENU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-menu">
  <div class="logo">Di<span class="accent">N</span>Go</div>
  <div class="tagline">Real-Time Multiplayer Bingo</div>

  <div class="card">
    <div class="card-label">Playing as</div>
    <div class="card-value" id="display-name">Guest_0000</div>
  </div>

  <button class="btn btn-primary" id="btn-quickplay">âš¡ Quick Play</button>
  <button class="btn btn-secondary" id="btn-private">ğŸ”’ Private Room</button>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€“ PUBLIC MATCHMAKING (queue)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-matchmaking">
  <div class="logo logo-small">Di<span class="accent">N</span>Go</div>
  <p style="color:var(--text-muted);font-size:0.82rem;margin-bottom:30px;letter-spacing:0.08em;">
    Finding an opponent<span class="dots"></span>
  </p>
  <div class="spinner"></div>
  <p style="color:var(--text-muted);font-size:0.77rem;text-align:center;max-width:240px;margin-top:8px;line-height:1.6;">
    You'll be matched instantly when another player enters the queue.
  </p>
  <button class="btn btn-secondary" id="btn-cancel-match" style="margin-top:28px;max-width:180px;">
    Cancel
  </button>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4 â€“ PRIVATE ROOM (create or join by code)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-private">
  <div class="logo logo-small">Di<span class="accent">N</span>Go</div>
  <p style="color:var(--text-muted);font-size:0.82rem;margin-bottom:28px;letter-spacing:0.08em;">
    Private Room
  </p>

  <button class="btn btn-primary" id="btn-create-room">ï¼‹ Create Room</button>

  <div class="divider">or join with a code</div>

  <div class="field-group">
    <label class="field-label" for="join-code-input">Room Code</label>
    <input type="text" id="join-code-input" class="code-input"
           placeholder="ABC123" maxlength="6" autocomplete="off"
           spellcheck="false" />
  </div>

  <button class="btn btn-secondary" id="btn-join-code">Join Room</button>
  <button class="btn-ghost" id="btn-back-private">â† Back to Menu</button>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 5 â€“ WAITING FOR GUEST TO JOIN (private room host)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-waiting">
  <div class="logo logo-small">Di<span class="accent">N</span>Go</div>
  <p style="color:var(--text-muted);font-size:0.82rem;margin-bottom:28px;letter-spacing:0.08em;">
    Waiting for opponent<span class="dots"></span>
  </p>

  <div class="card">
    <div class="card-label">Room Code</div>
    <div class="card-value" id="waiting-code" style="font-size:2rem;letter-spacing:0.35em;">
      ------
    </div>
  </div>

  <div class="copy-row">
    <input type="text" id="share-link-input" readonly placeholder="share link" />
    <button class="copy-btn" id="btn-copy-link">Copy Link</button>
  </div>

  <p style="color:var(--text-muted);font-size:0.77rem;text-align:center;max-width:270px;line-height:1.6;">
    Share the code or link with a friend. Game starts automatically when they join.
  </p>

  <div class="spinner" style="margin-top:16px;"></div>
  <button class="btn-ghost" id="btn-cancel-waiting" style="margin-top:4px;">Cancel Room</button>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 6 â€“ GAME BOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-game">

  <!-- Score header -->
  <div class="game-header">
    <div class="pinfo">
      <div class="pname" id="my-name">You</div>
      <div class="pscore" id="my-score">0</div>
      <div class="pips" id="my-pips">
        <div class="pip"></div><div class="pip"></div><div class="pip"></div>
        <div class="pip"></div><div class="pip"></div>
      </div>
    </div>
    <div class="vs-badge">VS</div>
    <div class="pinfo right">
      <div class="pname" id="opp-name">Opponent</div>
      <div class="pscore" id="opp-score">0</div>
      <div class="pips" id="opp-pips">
        <div class="pip"></div><div class="pip"></div><div class="pip"></div>
        <div class="pip"></div><div class="pip"></div>
      </div>
    </div>
  </div>

  <!-- Turn indicator -->
  <div class="turn-banner theirs" id="turn-banner">
    â³ Waiting for opponentâ€¦
  </div>

  <!-- Bingo board -->
  <div class="board-wrap">
    <div class="bingo-letters">
      <div class="bletter">B</div>
      <div class="bletter">I</div>
      <div class="bletter">N</div>
      <div class="bletter">G</div>
      <div class="bletter">O</div>
    </div>
    <div class="bingo-grid" id="bingo-grid">
      <!-- 25 cells rendered by JS -->
    </div>
  </div>

  <!-- Called numbers -->
  <div class="called-wrap">
    <div class="called-title">Called Numbers</div>
    <div class="called-chips" id="called-chips"></div>
  </div>

</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     OVERLAY â€“ GAME RESULT (win / lose)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="overlay-result">
  <div class="result-card">
    <div class="result-icon" id="result-icon">ğŸ‰</div>
    <div class="result-headline win" id="result-headline">YOU WIN!</div>
    <div class="result-sub" id="result-sub">5 lines â€” impressive!</div>
    <div class="rematch-waiting" id="rematch-waiting" style="display:none">
      Waiting for opponent<span class="dots"></span>
    </div>
    <button class="btn btn-success" id="btn-rematch">ğŸ”„ Rematch</button>
    <button class="btn btn-secondary" id="btn-leave">ğŸšª Leave</button>
  </div>
</div>

<!-- Toast notification -->
<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FIREBASE COMPAT SDK  (v9 compat â€“ no bundler required)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
         DiNGo â€“ Complete Game Logic
         Architecture: functional modules, single state object,
         explicit listener lifecycle management
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 0 â–¸ FIREBASE CONFIGURATION
   âš ï¸  Replace these placeholder values with your own Firebase
      project credentials from the Firebase Console.
      https://console.firebase.google.com â†’ Project settings â†’ SDK config
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAhhGzyMUJrfzYsOw4Uy-qu6F_IOqrh3PA",
  authDomain: "dingo-v2-0.firebaseapp.com",
  databaseURL: "https://dingo-v2-0-default-rtdb.firebaseio.com",
  projectId: "dingo-v2-0",
  storageBucket: "dingo-v2-0.firebasestorage.app",
  messagingSenderId: "908358383631",
  appId: "1:908358383631:web:09473d12f079a230134b7a",
  measurementId: "G-MFTX32JEDJ"

};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 1 â–¸ FIREBASE INIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db   = firebase.database();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 2 â–¸ GLOBAL STATE
   Single source of truth â€“ never mutate directly outside setters.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const State = {
  uid:         null,  // Firebase anonymous UID
  name:        null,  // "Guest_XXXX"
  roomId:      null,  // active room key in /rooms/
  board:       [],    // flat[25] â€“ null at index 12 = FREE center
  opponentId:  null,  // other player's UID
  opponentName:null,
  gameActive:  false, // true while game is in progress
  myLines:     new Set(), // completed line keys for current player
  _listeners:  [],    // { ref, event, fn } objects for cleanup
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 3 â–¸ UTILITIES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/** Navigate to a named screen (hides all others). */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

/** Transient toast message at the bottom of the screen. */
let _toastTimer;
function toast(msg, ms = 2800) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('visible');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove('visible'), ms);
}

/** 4-digit random suffix (1000â€“9999). */
function rnd4() {
  return Math.floor(1000 + Math.random() * 9000);
}

/** 6-char uppercase alphanumeric room code (avoids 0/O/I/1 confusion). */
function makeRoomId() {
  const alpha = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length: 6}, () => alpha[Math.floor(Math.random() * alpha.length)]).join('');
}

/**
 * Firebase sometimes returns arrays as objects with numeric string keys.
 * This helper normalises them back to a real JS array.
 */
function toArray(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val;
  // Object with sequential 0-based keys â†’ array
  return Object.keys(val)
    .sort((a, b) => Number(a) - Number(b))
    .map(k => val[k]);
}

/**
 * Register a Firebase listener and store it so it can be removed later.
 * Prevents duplicate listeners and memory leaks.
 */
function listen(ref, event, fn) {
  ref.on(event, fn);
  State._listeners.push({ ref, event, fn });
}

/** Remove every active Firebase listener registered via listen(). */
function cleanListeners() {
  State._listeners.forEach(({ ref, event, fn }) => ref.off(event, fn));
  State._listeners = [];
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 4 â–¸ BOARD GENERATION
   Standard Bingo column ranges:
     B 1-15 | I 16-30 | N 31-45 | G 46-60 | O 61-75
   Board is a flat array of 25 values; index 12 = FREE (null).
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/** Return a shuffled subset of [min, max]. */
function sample(min, max, count) {
  const pool = [];
  for (let n = min; n <= max; n++) pool.push(n);
  // Fisher-Yates
  for (let i = pool.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }
  return pool.slice(0, count);
}

function generateBoard() {
  const cols = [
    sample(1,  15, 5),  // B
    sample(16, 30, 5),  // I
    sample(31, 45, 5),  // N
    sample(46, 60, 5),  // G
    sample(61, 75, 5),  // O
  ];

  // Build flat row-major array (row 0â†’4, col 0â†’4)
  const flat = [];
  for (let row = 0; row < 5; row++) {
    for (let col = 0; col < 5; col++) {
      flat.push(row === 2 && col === 2 ? null : cols[col][row]);
    }
  }
  return flat; // length 25, index 12 is null (FREE)
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 5 â–¸ WIN DETECTION
   12 possible lines: 5 rows + 5 cols + 2 diagonals.
   Line key format: "r0"-"r4", "c0"-"c4", "d0", "d1"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/** Returns the 5 cell indices belonging to a given line key. */
function lineIndices(key) {
  if (key[0] === 'r') {
    const r = +key[1];
    return [0,1,2,3,4].map(c => r*5+c);
  }
  if (key[0] === 'c') {
    const c = +key[1];
    return [0,1,2,3,4].map(r => r*5+c);
  }
  if (key === 'd0') return [0,6,12,18,24];  // top-left â†’ bottom-right
  if (key === 'd1') return [4,8,12,16,20];  // top-right â†’ bottom-left
  return [];
}

/**
 * Calculates how many lines on `board` are completed given `calledSet`.
 * Returns an array of completed line keys.
 */
function completedLines(board, calledSet) {
  const isMarked = i => board[i] === null || calledSet.has(board[i]);

  const allKeys = [
    'r0','r1','r2','r3','r4',
    'c0','c1','c2','c3','c4',
    'd0','d1',
  ];

  return allKeys.filter(key =>
    lineIndices(key).every(i => isMarked(i))
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 6 â–¸ AUTHENTICATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function initAuth() {
  auth.onAuthStateChanged(user => {
    if (user) {
      State.uid  = user.uid;
      // Persist name across sessions so user always has same identity
      let name   = localStorage.getItem('dingo_name');
      if (!name) {
        name = 'Guest_' + rnd4();
        localStorage.setItem('dingo_name', name);
      }
      State.name = name;
      document.getElementById('display-name').textContent = name;
      onAuthenticated();
    } else {
      auth.signInAnonymously().catch(err => {
        console.error('[DiNGo] Auth failed:', err);
        toast('Connection error â€“ please refresh.');
      });
    }
  });
}

function onAuthenticated() {
  // Check for a ?room=XXXX invite in the URL
  const params      = new URLSearchParams(location.search);
  const inviteRoom  = params.get('room');

  if (inviteRoom) {
    // Clean up the URL so a refresh doesn't re-trigger
    if (history.replaceState) history.replaceState({}, '', location.pathname);
    joinPrivateRoom(inviteRoom.toUpperCase());
  } else {
    showScreen('screen-menu');
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 7 â–¸ PUBLIC MATCHMAKING (queue)
   Race-condition strategy:
     â€“ Both players write to /queue/<uid>
     â€“ We watch /queue for value changes
     â€“ When 2+ players exist, the lexicographically SMALLEST uid
       acts as "host" (deterministic, no transaction needed for
       host selection since only one client becomes host per pair)
     â€“ Host creates the room, removes both from queue, and writes
       a /queue_assignments/<guestUid> signal so guest learns the roomId
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

let _queueValueListener = null;  // separate from State._listeners for precise removal
let _myQueueRef         = null;

function enterQueue() {
  showScreen('screen-matchmaking');

  const queueRef = db.ref('queue');
  _myQueueRef    = queueRef.child(State.uid);

  // Announce ourselves in queue; auto-remove on disconnect
  _myQueueRef.set({ uid: State.uid, name: State.name });
  _myQueueRef.onDisconnect().remove();

  // HOST DETECTION: watch the queue for another player
  _queueValueListener = queueRef.on('value', snap => {
    const queue = snap.val();
    if (!queue) return;

    const uids = Object.keys(queue).sort();
    if (uids.length < 2) return;  // not enough players yet

    const [hostUid, guestUid] = uids;

    if (hostUid === State.uid) {
      // I am the host â€“ stop watching queue and build the room
      queueRef.off('value', _queueValueListener);
      _queueValueListener = null;

      const host  = queue[hostUid];
      const guest = queue[guestUid];
      createMatchRoom(makeRoomId(), host, guest, guestUid);
    }
    // Guest role: wait for /queue_assignments/<myUid>
  });

  // GUEST DETECTION: watch for an assignment written by the host
  const assignRef = db.ref('queue_assignments/' + State.uid);
  listen(assignRef, 'value', snap => {
    if (!snap.exists()) return;
    const { roomId } = snap.val();

    // Stop watching queue
    if (_queueValueListener) {
      db.ref('queue').off('value', _queueValueListener);
      _queueValueListener = null;
    }
    snap.ref.remove();   // clean up the assignment signal
    enterRoom(roomId);   // join the room created by host
  });
}

/** Host creates room, removes both from queue, signals guest. */
function createMatchRoom(roomId, host, guest, guestUid) {
  const hostBoard  = generateBoard();
  const guestBoard = generateBoard();

  const roomData = {
    status:    'playing',
    turn:      host.uid,   // host goes first
    winner:    null,
    called:    null,
    createdAt: Date.now(),
    players: {
      [host.uid]: {
        name:    host.name,
        score:   0,
        rematch: false,
        board:   hostBoard,
      },
      [guest.uid]: {
        name:    guest.name,
        score:   0,
        rematch: false,
        board:   guestBoard,
      },
    },
  };

  db.ref('rooms/' + roomId).set(roomData)
    .then(() => db.ref('queue').update({ [host.uid]: null, [guest.uid]: null }))
    .then(() => db.ref('queue_assignments/' + guestUid).set({ roomId }))
    .then(() => enterRoom(roomId))
    .catch(err => {
      console.error('[DiNGo] createMatchRoom failed:', err);
      toast('Matchmaking error â€“ please retry.');
      showScreen('screen-menu');
    });
}

function cancelMatchmaking() {
  if (_queueValueListener) {
    db.ref('queue').off('value', _queueValueListener);
    _queueValueListener = null;
  }
  if (_myQueueRef) {
    _myQueueRef.remove();
    _myQueueRef = null;
  }
  cleanListeners();
  showScreen('screen-menu');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 8 â–¸ PRIVATE ROOMS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function createPrivateRoom() {
  const roomId    = makeRoomId();
  const hostBoard = generateBoard();

  const roomData = {
    status:    'waiting',
    turn:      State.uid,
    winner:    null,
    called:    null,
    createdAt: Date.now(),
    players: {
      [State.uid]: {
        name:    State.name,
        score:   0,
        rematch: false,
        board:   hostBoard,
      },
    },
  };

  db.ref('rooms/' + roomId).set(roomData)
    .then(() => {
      State.roomId = roomId;

      // Presence: remove my entry if I close the tab while waiting
      db.ref(`rooms/${roomId}/players/${State.uid}`)
        .onDisconnect().remove();

      // Show the waiting screen with the room code
      document.getElementById('waiting-code').textContent = roomId;
      const link = `${location.origin}${location.pathname}?room=${roomId}`;
      document.getElementById('share-link-input').value = link;
      showScreen('screen-waiting');

      // Wait for a second player to join
      const playersRef = db.ref(`rooms/${roomId}/players`);
      listen(playersRef, 'value', snap => {
        const players = snap.val() || {};
        if (Object.keys(players).length >= 2) {
          cleanListeners();  // remove this watcher before entering game
          enterRoom(roomId);
        }
      });
    })
    .catch(err => {
      console.error('[DiNGo] createPrivateRoom failed:', err);
      toast('Could not create room â€“ try again.');
    });
}

function joinPrivateRoom(roomId) {
  db.ref('rooms/' + roomId).once('value')
    .then(snap => {
      if (!snap.exists()) {
        toast('Room not found.');
        showScreen('screen-private');
        return;
      }

      const room    = snap.val();
      const players = room.players || {};
      const uids    = Object.keys(players);

      // Already in the room (e.g., page refresh) â†’ just re-enter
      if (uids.includes(State.uid)) {
        enterRoom(roomId);
        return;
      }

      if (room.status !== 'waiting') {
        toast('This room is no longer open.');
        showScreen('screen-private');
        return;
      }
      if (uids.length >= 2) {
        toast('This room is full.');
        showScreen('screen-private');
        return;
      }

      // Add guest and flip status to 'playing'
      const guestBoard = generateBoard();
      const updates = {
        [`players/${State.uid}`]: {
          name:    State.name,
          score:   0,
          rematch: false,
          board:   guestBoard,
        },
        status: 'playing',
      };

      db.ref('rooms/' + roomId).update(updates)
        .then(() => {
          db.ref(`rooms/${roomId}/players/${State.uid}`)
            .onDisconnect().remove();
          enterRoom(roomId);
        });
    })
    .catch(err => {
      console.error('[DiNGo] joinPrivateRoom failed:', err);
      toast('Could not join room.');
      showScreen('screen-private');
    });
}

function cancelWaiting() {
  cleanListeners();
  if (State.roomId) {
    db.ref('rooms/' + State.roomId).remove();
    State.roomId = null;
  }
  showScreen('screen-menu');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 9 â–¸ ENTER & WATCH ROOM
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function enterRoom(roomId) {
  cleanListeners();  // remove any stale watchers

  State.roomId     = roomId;
  State.gameActive = true;
  State.myLines    = new Set();

  // Clear the URL invite param (avoid re-join on refresh)
  if (history.replaceState) history.replaceState({}, '', location.pathname);

  // Guarantee our presence entry auto-removes on disconnect
  db.ref(`rooms/${roomId}/players/${State.uid}`)
    .onDisconnect().remove();

  // Load room once to initialise local state, then subscribe
  db.ref('rooms/' + roomId).once('value')
    .then(snap => {
      if (!snap.exists()) {
        toast('Room disappeared.');
        resetToMenu();
        return;
      }

      const room    = snap.val();
      const players = room.players || {};
      const opUid   = Object.keys(players).find(u => u !== State.uid);

      State.opponentId   = opUid || null;
      State.opponentName = opUid ? players[opUid].name : 'Opponent';
      State.board        = toArray(players[State.uid].board);

      // Render the board UI
      renderBoard();
      document.getElementById('my-name').textContent  = State.name;
      document.getElementById('opp-name').textContent = State.opponentName;
      showScreen('screen-game');

      // Subscribe to all relevant room sub-paths
      watchRoom(roomId);
    })
    .catch(err => {
      console.error('[DiNGo] enterRoom failed:', err);
      toast('Failed to load room.');
      resetToMenu();
    });
}

/**
 * Subscribe to all room sub-paths. Each watcher handles one concern.
 * Using separate paths (not root) avoids re-rendering everything on each write.
 */
function watchRoom(roomId) {
  const R = db.ref('rooms/' + roomId);

  /* â€” called numbers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  listen(R.child('called'), 'value', snap => {
    const raw        = snap.val() || {};
    const called     = Object.values(raw).map(Number);
    const calledSet  = new Set(called);

    applyCalledToBoard(calledSet);
    renderCalledChips(called);

    // Recalculate my line score and write it back to DB
    const lines = completedLines(State.board, calledSet);
    State.myLines = new Set(lines);
    highlightLines(lines);
    updateMyScore(lines.length, calledSet);
  });

  /* â€” whose turn â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  listen(R.child('turn'), 'value', snap => {
    renderTurnBanner(snap.val());
  });

  /* â€” game status / winner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  listen(R.child('status'), 'value', snap => {
    if (snap.val() === 'finished') {
      R.child('winner').once('value').then(ws => showResult(ws.val()));
    }
  });

  /* â€” players node (presence + opponent score + rematch) â”€â”€â”€ */
  listen(R.child('players'), 'value', snap => {
    const players = snap.val();

    // Room deleted / everyone left
    if (!players) {
      handleRoomGone();
      return;
    }

    const uids = Object.keys(players);

    // Discover opponent late (e.g. if we're the first one in)
    if (!State.opponentId) {
      const opUid = uids.find(u => u !== State.uid);
      if (opUid) {
        State.opponentId   = opUid;
        State.opponentName = players[opUid].name;
        document.getElementById('opp-name').textContent = State.opponentName;
      }
    }

    // Opponent score
    if (State.opponentId && players[State.opponentId]) {
      const oppScore = players[State.opponentId].score || 0;
      document.getElementById('opp-score').textContent = oppScore;
      renderPips('opp-pips', oppScore);
    }

    // Opponent disconnected mid-game
    if (State.opponentId && !uids.includes(State.opponentId)) {
      handleOpponentLeft(roomId);
    }

    // Rematch check: both players set rematch = true
    if (State.opponentId && players[State.uid]?.rematch && players[State.opponentId]?.rematch) {
      doRematch(roomId, players);
    }
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 10 â–¸ BOARD RENDERING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function renderBoard() {
  const grid = document.getElementById('bingo-grid');
  grid.innerHTML = '';

  State.board.forEach((num, idx) => {
    const cell       = document.createElement('div');
    const isFree     = num === null;
    cell.className   = 'cell' + (isFree ? ' free marked' : '');
    cell.dataset.idx = idx;
    cell.dataset.num = isFree ? 'FREE' : num;
    cell.textContent = isFree ? 'FREE' : num;

    if (!isFree) {
      cell.addEventListener('click', () => handleCellClick(num, cell));
    }

    grid.appendChild(cell);
  });
}

function applyCalledToBoard(calledSet) {
  document.querySelectorAll('#bingo-grid .cell:not(.free)').forEach(cell => {
    const num = Number(cell.dataset.num);
    cell.classList.toggle('marked', calledSet.has(num));
  });
}

function highlightLines(lineKeys) {
  // Clear all previous line-win highlights
  document.querySelectorAll('#bingo-grid .cell.line-win')
    .forEach(c => c.classList.remove('line-win'));

  lineKeys.forEach(key => {
    lineIndices(key).forEach(i => {
      const cell = document.querySelector(`#bingo-grid .cell[data-idx="${i}"]`);
      if (cell) cell.classList.add('line-win');
    });
  });
}

function renderTurnBanner(turnUid) {
  const banner  = document.getElementById('turn-banner');
  const isMyTurn = turnUid === State.uid;

  if (isMyTurn) {
    banner.className   = 'turn-banner mine';
    banner.textContent = 'âš¡ Your turn â€“ tap a number!';
  } else {
    banner.className   = 'turn-banner theirs';
    banner.textContent = `â³ ${State.opponentName || 'Opponent'}'s turnâ€¦`;
  }

  // Update cell clickability appearance
  document.querySelectorAll('#bingo-grid .cell:not(.free)').forEach(cell => {
    cell.classList.toggle('clickable', isMyTurn);
    cell.classList.toggle('dimmed', !isMyTurn);
  });
}

function renderCalledChips(called) {
  const el = document.getElementById('called-chips');
  el.innerHTML = '';
  called.slice().sort((a, b) => a - b).forEach(n => {
    const chip       = document.createElement('span');
    chip.className   = 'chip';
    chip.textContent = n;
    el.appendChild(chip);
  });
}

function renderPips(containerId, count) {
  const pips = document.querySelectorAll(`#${containerId} .pip`);
  pips.forEach((pip, i) => pip.classList.toggle('on', i < count));
}

function updateMyScore(lineCount, calledSet) {
  document.getElementById('my-score').textContent = lineCount;
  renderPips('my-pips', lineCount);

  // Persist score to DB for opponent's UI to read
  db.ref(`rooms/${State.roomId}/players/${State.uid}/score`).set(lineCount);

  // WIN CONDITION: 5 lines completed
  if (lineCount >= 5 && State.gameActive) {
    // Use a transaction to safely claim the win (avoid race if both hit 5)
    const roomRef = db.ref('rooms/' + State.roomId);
    roomRef.child('status').transaction(currentStatus => {
      if (currentStatus === 'playing') return 'finished';
      return; // abort â€“ someone else already finished it
    }).then(result => {
      if (result.committed) {
        roomRef.child('winner').set(State.uid);
      }
    });
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 11 â–¸ TURN HANDLING (anti-cheat, server-side validation)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function handleCellClick(num, cellEl) {
  if (!State.gameActive) return;
  if (cellEl.classList.contains('marked')) { toast('Already called!'); return; }
  if (cellEl.classList.contains('dimmed'))  { toast('Not your turn!'); return; }

  // VALIDATION: re-read turn from DB before writing.
  // This prevents a fast-click or out-of-sync client from cheating.
  db.ref(`rooms/${State.roomId}/turn`).once('value').then(snap => {
    if (snap.val() !== State.uid) {
      toast('Not your turn!');
      return;
    }
    if (cellEl.classList.contains('marked')) return;  // raced with opponent

    submitCall(num);
  });
}

function submitCall(num) {
  if (!State.opponentId) return;

  const roomRef   = db.ref('rooms/' + State.roomId);
  const calledRef = roomRef.child('called');

  // Read current called list to compute post-call line count
  calledRef.once('value').then(snap => {
    const prev       = snap.val() ? Object.values(snap.val()).map(Number) : [];
    const nextCalled = new Set([...prev, num]);
    const myLines    = completedLines(State.board, nextCalled);
    const won        = myLines.length >= 5;

    // Build atomic multi-path update
    const newPushKey = calledRef.push().key;
    const update = {
      [`called/${newPushKey}`]: num,
      turn:                     State.opponentId, // pass turn to opponent
    };

    if (won) {
      update.status = 'finished';
      update.winner = State.uid;
    }

    roomRef.update(update).catch(err => {
      console.error('[DiNGo] submitCall failed:', err);
      toast('Error submitting â€“ try again.');
    });
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 12 â–¸ RESULT SCREEN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function showResult(winnerUid) {
  State.gameActive = false;

  const didWin = winnerUid === State.uid;

  document.getElementById('result-icon').textContent     = didWin ? 'ğŸ‰' : 'ğŸ˜”';
  document.getElementById('result-headline').textContent  = didWin ? 'YOU WIN!' : 'YOU LOSE';
  document.getElementById('result-headline').className    = 'result-headline ' + (didWin ? 'win' : 'lose');
  document.getElementById('result-sub').textContent       = didWin
    ? '5 lines â€“ excellent!'
    : `${State.opponentName || 'Opponent'} completed 5 lines`;

  document.getElementById('rematch-waiting').style.display = 'none';
  document.getElementById('btn-rematch').disabled  = false;
  document.getElementById('btn-rematch').textContent = 'ğŸ”„ Rematch';

  document.getElementById('overlay-result').classList.add('show');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 13 â–¸ REMATCH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function requestRematch() {
  // Signal our intent; the players watcher will detect when both agree
  document.getElementById('btn-rematch').disabled   = true;
  document.getElementById('btn-rematch').textContent = 'â³ Waitingâ€¦';
  document.getElementById('rematch-waiting').style.display = 'block';

  db.ref(`rooms/${State.roomId}/players/${State.uid}/rematch`).set(true);
}

/**
 * Called when both players have rematch = true.
 * Uses a transaction on `status` so only one client performs the reset.
 */
function doRematch(roomId, players) {
  const roomRef = db.ref('rooms/' + roomId);

  roomRef.child('status').transaction(current => {
    if (current === 'finished') return 'resetting';
    return; // abort â€“ already handled
  }).then(({ committed }) => {
    if (!committed) return;

    // Generate fresh boards for both players
    const uids = Object.keys(players);
    const boards = {};
    uids.forEach(uid => { boards[uid] = generateBoard(); });

    const update = {
      called:  null,
      winner:  null,
      status:  'playing',
      turn:    uids[0], // first uid alphabetically goes first
    };

    uids.forEach(uid => {
      update[`players/${uid}/score`]   = 0;
      update[`players/${uid}/rematch`] = false;
      update[`players/${uid}/board`]   = boards[uid];
    });

    roomRef.update(update).then(() => {
      // Update our local board and reset UI
      State.board      = boards[State.uid];
      State.myLines    = new Set();
      State.gameActive = true;

      document.getElementById('overlay-result').classList.remove('show');
      renderBoard();
    });
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 14 â–¸ LEAVE & ROOM CLEANUP
   No Cloud Functions â€“ all cleanup is client-side.
   Strategy:
     â€¢ Player A leaves â†’ removes own /players/<uid> node
     â€¢ checkAndCleanRoom() reads remaining player count
     â€¢ 0 players â†’ delete room immediately
     â€¢ 1 player  â†’ set a 60-second timer; delete if still 1 after that
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function leaveGame() {
  const roomId = State.roomId;

  document.getElementById('overlay-result').classList.remove('show');
  cleanListeners();

  const prevRoomId   = State.roomId;
  State.gameActive   = false;
  State.roomId       = null;
  State.opponentId   = null;
  State.opponentName = null;
  State.board        = [];
  State.myLines      = new Set();

  if (prevRoomId) {
    db.ref(`rooms/${prevRoomId}/players/${State.uid}`)
      .remove()
      .then(() => checkAndCleanRoom(prevRoomId));
  }

  showScreen('screen-menu');
}

function checkAndCleanRoom(roomId) {
  db.ref(`rooms/${roomId}/players`).once('value').then(snap => {
    const players = snap.val();
    const count   = players ? Object.keys(players).length : 0;

    if (count === 0) {
      // Everyone is gone â€“ delete immediately
      db.ref('rooms/' + roomId).remove();
    } else if (count === 1) {
      // One player remains â€“ give them 60 s to get a new opponent
      // Use a dedicated cleanup flag so multiple clients don't double-delete
      const flagRef = db.ref('cleanup/' + roomId);
      flagRef.set(Date.now());
      flagRef.onDisconnect().remove();

      setTimeout(() => {
        db.ref(`rooms/${roomId}/players`).once('value').then(s => {
          const remaining = s.val() ? Object.keys(s.val()).length : 0;
          if (remaining <= 1) db.ref('rooms/' + roomId).remove();
          flagRef.remove();
        });
      }, 60_000);
    }
  });
}

function handleOpponentLeft(roomId) {
  // Don't override an already-finished game
  db.ref(`rooms/${roomId}/status`).once('value').then(snap => {
    if (snap.val() === 'finished') return;
    // Opponent left during active game â€“ award win to remaining player
    db.ref('rooms/' + roomId).update({ status: 'finished', winner: State.uid });
    toast('Opponent disconnected â€“ you win!', 3500);
  });
}

function handleRoomGone() {
  if (!State.gameActive && !State.roomId) return;
  cleanListeners();
  State.gameActive = false;
  document.getElementById('overlay-result').classList.remove('show');
  toast('Room was closed.');
  resetToMenu();
}

function resetToMenu() {
  State.roomId      = null;
  State.opponentId  = null;
  State.board       = [];
  State.myLines     = new Set();
  State.gameActive  = false;
  showScreen('screen-menu');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 15 â–¸ DOM EVENT WIRING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function initDOMEvents() {
  /* Main menu */
  document.getElementById('btn-quickplay').addEventListener('click', enterQueue);
  document.getElementById('btn-private').addEventListener('click', () => showScreen('screen-private'));

  /* Matchmaking */
  document.getElementById('btn-cancel-match').addEventListener('click', cancelMatchmaking);

  /* Private room */
  document.getElementById('btn-create-room').addEventListener('click', createPrivateRoom);
  document.getElementById('btn-back-private').addEventListener('click', () => showScreen('screen-menu'));
  document.getElementById('btn-join-code').addEventListener('click', () => {
    const code = document.getElementById('join-code-input').value.trim().toUpperCase();
    if (code.length < 4) { toast('Enter a valid room code.'); return; }
    joinPrivateRoom(code);
  });

  // Uppercase-transform the join input as user types
  document.getElementById('join-code-input').addEventListener('input', function () {
    this.value = this.value.toUpperCase();
  });

  /* Waiting screen */
  document.getElementById('btn-cancel-waiting').addEventListener('click', cancelWaiting);
  document.getElementById('btn-copy-link').addEventListener('click', () => {
    const link = document.getElementById('share-link-input').value;
    navigator.clipboard
      .writeText(link)
      .then(() => toast('Link copied to clipboard!'))
      .catch(() => {
        // Fallback for environments where clipboard API is unavailable
        const inp = document.getElementById('share-link-input');
        inp.select();
        try { document.execCommand('copy'); toast('Link copied!'); } catch (_) {}
      });
  });

  /* Result overlay */
  document.getElementById('btn-rematch').addEventListener('click', requestRematch);
  document.getElementById('btn-leave').addEventListener('click', leaveGame);

  /* Prevent accidental back navigation during game */
  window.addEventListener('popstate', () => {
    if (State.gameActive) history.pushState(null, '', location.pathname);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODULE 16 â–¸ PWA (Inline Manifest + Service Worker via Blob URLs)
   Using Blob URLs avoids needing external manifest.json / sw.js files,
   making the app fully self-contained in one HTML file.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function initPWA() {
  // â”€â”€â”€ Inline Web App Manifest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const manifest = {
    name:             'DiNGo â€“ Multiplayer Bingo',
    short_name:       'DiNGo',
    description:      'Real-time multiplayer bingo â€“ Quick Play or invite friends!',
    start_url:        '.',
    display:          'standalone',
    orientation:      'portrait',
    background_color: '#080a14',
    theme_color:      '#ff3d5a',
    icons: [{
      // Inline SVG icon works for most platforms
      src: [
        'data:image/svg+xml,',
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">',
        '<rect width="512" height="512" rx="96" fill="%23080a14"/>',
        '<text x="80" y="340" font-size="320" font-family="Arial">ğŸ±</text>',
        '</svg>'
      ].join(''),
      sizes: 'any',
      type:  'image/svg+xml',
      purpose: 'any maskable',
    }],
  };

  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
  document.getElementById('pwa-manifest').href = URL.createObjectURL(manifestBlob);

  // â”€â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!('serviceWorker' in navigator)) return;

  const swSource = `
    const CACHE = 'dingo-v2';

    self.addEventListener('install', e => {
      // Cache the app shell (this very page)
      e.waitUntil(
        caches.open(CACHE).then(c => c.addAll([self.registration.scope]))
      );
      self.skipWaiting();
    });

    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(keys =>
          Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
        )
      );
      self.clients.claim();
    });

    self.addEventListener('fetch', e => {
      const url = e.request.url;
      // Let Firebase and Google APIs always go through the network
      if (url.includes('firebase') || url.includes('googleapis') || url.includes('gstatic')) return;
      // Network-first with cache fallback for the app shell
      e.respondWith(
        fetch(e.request)
          .then(r => {
            const clone = r.clone();
            caches.open(CACHE).then(c => c.put(e.request, clone));
            return r;
          })
          .catch(() => caches.match(e.request))
      );
    });
  `;

  const swBlob = new Blob([swSource], { type: 'application/javascript' });
  const swUrl  = URL.createObjectURL(swBlob);

  navigator.serviceWorker.register(swUrl, { scope: '/' })
    .catch(err => console.warn('[DiNGo] SW registration skipped:', err.message));
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   BOOTSTRAP â€“ Wire everything together on DOM ready
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
  initPWA();         // register SW + manifest (non-blocking)
  initDOMEvents();   // attach all button listeners
  initAuth();        // triggers Firebase auth â†’ onAuthenticated()
});

</script>
</body>
</html>
